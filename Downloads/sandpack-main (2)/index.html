<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Cursor Clone - AI-Powered Code Editor in your browser">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Cursor Clone - Ultimate Max Edition</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22Cursor%20Clone%22,%22short_name%22:%22Cursor%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%231e1e1e%22,%22theme_color%22:%22%231e1e1e%22,%22icons%22:[{%22src%22:%22https://cdn.jsdelivr.net/npm/@vscode/codicons/src/icons/terminal.svg%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]}">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@vscode/codicons/dist/codicon.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">
    <style>
        :root {
            --bg: #1e1e1e;
            --sidebar: #252526;
            --border: #3e3e42;
            --text: #cccccc;
            --text2: #858585;
            --accent: #0078d4;
            --hover: #2a2d2e;
            --selection: #37373d;
            --success: #4ec9b0;
            --warning: #dcdcaa;
            --error: #f14c4c;
        }
        
        .theme-light {
            --bg: #ffffff;
            --sidebar: #f3f3f3;
            --border: #e0e0e0;
            --text: #333333;
            --text2: #666666;
            --hover: #e8e8e8;
            --selection: #add6ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font: 13px/1.4 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        .hidden { display: none !important; }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 40px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--error); }
        .toast.info { border-left: 4px solid var(--accent); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Layout */
        .main { display: flex; flex: 1; overflow: hidden; }
        
        /* Resizers */
        .resize-h, .resize-v { background: transparent; flex-shrink: 0; z-index: 10; }
        .resize-h { width: 4px; cursor: col-resize; }
        .resize-v { height: 4px; cursor: row-resize; }
        .resize-h:hover, .resize-v:hover, .resizing { background: var(--accent) !important; }

        /* Activity Bar */
        .activity { width: 48px; background: #333; display: flex; flex-direction: column; align-items: center; padding-top: 5px; flex-shrink: 0; }
        .act-item { width: 48px; height: 48px; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0.6; border-left: 2px solid transparent; position: relative; }
        .act-item:hover { opacity: 1; }
        .act-item.active { opacity: 1; border-left-color: white; }
        .act-item .codicon { font-size: 24px; }
        .act-item .badge { position: absolute; top: 8px; right: 8px; background: var(--accent); color: white; font-size: 10px; padding: 1px 5px; border-radius: 10px; }

        /* Sidebar */
        .sidebar { width: 260px; min-width: 150px; max-width: 500px; background: var(--sidebar); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-view { display: none; flex-direction: column; flex: 1; overflow: hidden; }
        .sidebar-view.active { display: flex; }
        .side-header { padding: 10px 15px; font-size: 11px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; height: 35px; flex-shrink: 0; }
        .side-header i { cursor: pointer; padding: 4px; border-radius: 3px; }
        .side-header i:hover { background: var(--hover); }
        .side-actions { display: flex; gap: 2px; }

        /* File Tree */
        .file-tree { overflow-y: auto; flex: 1; padding: 5px 0; }
        .tree-item { padding: 4px 10px; cursor: pointer; display: flex; align-items: center; gap: 6px; user-select: none; }
        .tree-item:hover { background: var(--hover); }
        .tree-item.active { background: var(--selection); }
        .tree-item.folder { font-weight: 500; }
        .tree-item .modified { width: 8px; height: 8px; background: white; border-radius: 50%; margin-left: auto; }
        .file-icon { width: 16px; text-align: center; flex-shrink: 0; }
        
        /* Search Panel */
        .search-box { padding: 10px; }
        .search-input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 4px; }
        .search-input:focus { outline: 1px solid var(--accent); }
        .search-results { overflow-y: auto; flex: 1; }
        .search-result { padding: 5px 15px; cursor: pointer; font-size: 12px; }
        .search-result:hover { background: var(--hover); }
        .search-result-file { color: var(--accent); font-weight: 500; }
        .search-result-line { color: var(--text2); }
        .search-match { background: rgba(255, 200, 0, 0.3); }

        /* Git Panel */
        .git-section { padding: 10px 15px; border-bottom: 1px solid var(--border); }
        .git-section-title { font-size: 11px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .git-file { padding: 3px 10px; display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; }
        .git-file:hover { background: var(--hover); }
        .git-status { font-size: 10px; font-weight: bold; width: 16px; text-align: center; }
        .git-status.M { color: var(--warning); }
        .git-status.A { color: var(--success); }
        .git-status.D { color: var(--error); }

        /* Editor Area */
        .editor-wrap { flex: 1; display: flex; flex-direction: column; min-width: 200px; overflow: hidden; }
        
        /* Breadcrumbs */
        .breadcrumbs { height: 22px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10px; font-size: 12px; color: var(--text2); flex-shrink: 0; }
        .breadcrumb { cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .breadcrumb:hover { color: var(--text); }
        .breadcrumb-sep { margin: 0 4px; }

        /* Tabs */
        .tabs { height: 35px; background: var(--sidebar); display: flex; overflow-x: auto; flex-shrink: 0; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { display: flex; align-items: center; padding: 0 10px; gap: 6px; cursor: pointer; border-right: 1px solid var(--border); min-width: 100px; max-width: 180px; font-size: 13px; position: relative; }
        .tab.active { background: var(--bg); border-top: 1px solid var(--accent); }
        .tab.inactive { background: #2d2d2d; color: var(--text2); }
        .tab .modified-dot { width: 8px; height: 8px; background: white; border-radius: 50%; }
        .tab-close { margin-left: auto; opacity: 0; padding: 2px; border-radius: 3px; }
        .tab:hover .tab-close { opacity: 1; }
        .tab-close:hover { background: #444; }

        /* Editor Content */
        .editors-container { flex: 1; display: flex; overflow: hidden; }
        .editor-pane { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .editor-content { flex: 1; position: relative; overflow: hidden; }
        .empty-editor { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text2); gap: 20px; }
        .shortcuts { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 30px; text-align: left; }
        .shortcut { cursor: pointer; display: contents; }
        .shortcut:hover .label { color: var(--accent); }
        .key { background: #333; padding: 2px 6px; border-radius: 3px; font-family: monospace; }

        /* Preview Pane */
        .preview-pane { flex: 1; background: white; border-left: 1px solid var(--border); display: none; }
        .preview-pane.active { display: block; }
        .preview-pane iframe { width: 100%; height: 100%; border: none; }
        .preview-header { height: 35px; background: var(--sidebar); display: flex; align-items: center; padding: 0 15px; justify-content: space-between; border-bottom: 1px solid var(--border); }

        /* Bottom Panel */
        .bottom-panel { height: 200px; min-height: 35px; max-height: 70vh; border-top: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .bottom-panel.collapsed { height: 35px !important; }
        .panel-header { display: flex; padding: 0 15px; border-bottom: 1px solid var(--border); height: 35px; align-items: center; background: var(--sidebar); flex-shrink: 0; }
        .panel-tab { padding: 0 12px; cursor: pointer; color: var(--text2); font-size: 11px; text-transform: uppercase; height: 100%; display: flex; align-items: center; gap: 5px; }
        .panel-tab.active { color: white; border-bottom: 1px solid white; }
        .panel-tab .count { background: var(--border); padding: 1px 6px; border-radius: 10px; font-size: 10px; }
        .panel-body { flex: 1; overflow: hidden; display: none; }
        .panel-body.active { display: flex; flex-direction: column; }
        .term-wrap { flex: 1; padding: 5px; background: #0c0c0c; }
        .problems-list { overflow-y: auto; flex: 1; }
        .problem-item { padding: 5px 15px; display: flex; align-items: center; gap: 10px; font-size: 12px; cursor: pointer; }
        .problem-item:hover { background: var(--hover); }
        .problem-icon { font-size: 14px; }
        .problem-icon.error { color: var(--error); }
        .problem-icon.warning { color: var(--warning); }

        /* AI Sidebar */
        .ai-side { width: 400px; min-width: 280px; max-width: 700px; background: var(--bg); display: flex; flex-direction: column; flex-shrink: 0; border-left: 1px solid var(--border); }
        .ai-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); font-weight: 600; flex-shrink: 0; }
        .ai-header i { cursor: pointer; padding: 4px; border-radius: 3px; }
        .ai-header i:hover { background: var(--hover); }
        
        /* Chat */
        .chat-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg { font-size: 13px; line-height: 1.6; max-width: 95%; }
        .msg.user { align-self: flex-end; background: #2b2d31; padding: 10px 14px; border-radius: 12px; border: 1px solid #3f4148; }
        .msg.ai { align-self: flex-start; }
        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; }
        .msg-context { font-size: 11px; color: var(--accent); margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 5px; }
        .context-badge { background: rgba(0,120,212,0.1); border: 1px solid var(--accent); padding: 2px 8px; border-radius: 12px; cursor: pointer; }
        .context-badge:hover { background: rgba(0,120,212,0.2); }
        
        /* Code Blocks in Chat */
        .code-block { position: relative; margin: 10px 0; }
        .code-block pre { background: #1e1e1e; padding: 12px; border-radius: 6px; overflow-x: auto; font-family: 'Consolas', monospace; font-size: 13px; }
        .code-block-header { display: flex; justify-content: space-between; align-items: center; background: #2d2d2d; padding: 5px 12px; border-radius: 6px 6px 0 0; font-size: 11px; }
        .code-block-header + pre { border-radius: 0 0 6px 6px; margin-top: 0; }
        .code-actions { display: flex; gap: 5px; }
        .code-action { cursor: pointer; padding: 3px 8px; border-radius: 3px; background: #444; font-size: 11px; }
        .code-action:hover { background: #555; }
        .code-action.primary { background: var(--accent); }

        /* AI Input */
        .ai-input-wrap { padding: 15px; border-top: 1px solid var(--border); background: var(--sidebar); flex-shrink: 0; }
        .model-row { margin-bottom: 8px; display: flex; gap: 8px; align-items: center; }
        .model-select { background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 5px 10px; font-size: 12px; cursor: pointer; flex: 1; }
        .ai-input-container { position: relative; }
        .ai-input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px; padding-right: 40px; border-radius: 8px; resize: none; height: 80px; font: inherit; }
        .ai-input:focus { outline: 1px solid var(--accent); }
        .mentions-dropdown { position: absolute; bottom: 100%; left: 0; right: 0; background: var(--sidebar); border: 1px solid var(--border); border-radius: 6px; max-height: 200px; overflow-y: auto; display: none; }
        .mentions-dropdown.open { display: block; }
        .mention-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .mention-item:hover { background: var(--hover); }
        .send-btn { position: absolute; right: 10px; bottom: 10px; background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .send-btn:hover { background: #026ec1; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modals */
        .modal { position: fixed; inset: 0; z-index: 1000; display: none; background: rgba(0,0,0,0.5); }
        .modal.open { display: flex; justify-content: center; align-items: flex-start; padding-top: 50px; }
        .modal-box { background: var(--sidebar); border: 1px solid var(--border); border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Command Palette */
        .palette-box { width: 600px; background: var(--sidebar); border-radius: 8px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .palette-input { width: 100%; background: var(--bg); border: none; padding: 15px; color: var(--text); font-size: 14px; }
        .palette-input:focus { outline: none; }
        .palette-list { max-height: 400px; overflow-y: auto; }
        .palette-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .palette-item:hover, .palette-item.selected { background: var(--accent); }
        .palette-item-icon { width: 20px; text-align: center; opacity: 0.7; }
        .palette-item-label { flex: 1; }
        .palette-item-shortcut { font-size: 11px; opacity: 0.6; font-family: monospace; }

        /* Context Menu */
        .context-menu { position: fixed; background: var(--sidebar); border: 1px solid var(--border); border-radius: 6px; padding: 5px 0; z-index: 2000; min-width: 180px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .context-menu-item { padding: 6px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .context-menu-item:hover { background: var(--accent); }
        .context-menu-sep { height: 1px; background: var(--border); margin: 5px 0; }

        /* Buttons */
        .btn { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font: inherit; }
        .btn:hover { background: #026ec1; }
        .btn.secondary { background: var(--border); }
        .btn.secondary:hover { background: #555; }

        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 12px; color: var(--text2); }
        .form-input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 4px; }
        .form-input:focus { outline: 1px solid var(--accent); }

        /* Status Bar */
        .status { height: 22px; background: var(--accent); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; font-size: 12px; color: white; flex-shrink: 0; }
        .status-left, .status-right { display: flex; gap: 15px; }
        .status-item { cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 0 5px; }
        .status-item:hover { background: rgba(255,255,255,0.1); }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Ctrl+K Inline Edit */
        .inline-edit-box { width: 700px; background: var(--sidebar); border-radius: 8px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .inline-edit-header { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .inline-edit-file { font-size: 12px; color: var(--accent); }
        .inline-edit-input { width: 100%; background: var(--bg); border: none; padding: 12px 15px; color: var(--text); font-size: 14px; }
        .inline-edit-input:focus { outline: none; }
        .inline-edit-preview { max-height: 400px; overflow-y: auto; }
        .diff-header { display: flex; padding: 8px 15px; background: #2d2d2d; font-size: 11px; text-transform: uppercase; }
        .diff-old { flex: 1; color: #f85149; }
        .diff-new { flex: 1; color: #3fb950; }
        .diff-content { display: flex; font-family: monospace; font-size: 13px; }
        .diff-side { flex: 1; padding: 10px; white-space: pre-wrap; overflow-x: auto; }
        .diff-side.old { background: rgba(248, 81, 73, 0.1); border-right: 1px solid var(--border); }
        .diff-side.new { background: rgba(63, 185, 80, 0.1); }
        .diff-line-add { background: rgba(63, 185, 80, 0.3); }
        .diff-line-remove { background: rgba(248, 81, 73, 0.3); }
        .inline-edit-actions { padding: 12px 15px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        /* Zen Mode */
        .zen-mode .activity, .zen-mode .sidebar, .zen-mode .ai-side, .zen-mode .status, .zen-mode .bottom-panel,
        .zen-mode .tabs, .zen-mode .breadcrumbs, .zen-mode #rSidebar, .zen-mode #rAI { display: none !important; }
        .zen-mode .editor-wrap { margin: 0; }
        .zen-mode #monaco { height: 100vh !important; }

        /* Outline View */
        .outline-item { padding: 4px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .outline-item:hover { background: var(--hover); }
        .outline-item .type { font-size: 10px; padding: 1px 4px; border-radius: 3px; }
        .outline-item .type.function { background: #4fc1ff20; color: #4fc1ff; }
        .outline-item .type.class { background: #dcdcaa20; color: #dcdcaa; }
        .outline-item .type.variable { background: #9cdcfe20; color: #9cdcfe; }

        /* Version History */
        .version-item { padding: 8px 15px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .version-item:hover { background: var(--hover); }
        .version-time { font-size: 11px; color: var(--text2); }
        .version-changes { font-size: 12px; margin-top: 4px; }

        /* AI Agents */
        .agent-selector { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .agent-btn { padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; border: 1px solid var(--border); background: transparent; color: var(--text); }
        .agent-btn:hover { background: var(--hover); }
        .agent-btn.active { background: var(--accent); border-color: var(--accent); }

        /* Tab Completion Ghost */
        .ghost-text { color: #666; font-style: italic; }

        /* Split View */
        .split-divider { width: 4px; background: var(--border); cursor: col-resize; }
        .split-divider:hover { background: var(--accent); }

        /* AI Ghost Text */
        .ghost-suggestion {
            position: absolute;
            color: #666;
            font-style: italic;
            pointer-events: none;
            white-space: pre;
        }

        /* Markdown Preview */
        .markdown-preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg);
        }
        .markdown-body { background: transparent !important; color: var(--text) !important; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { border-bottom-color: var(--border) !important; }
        .markdown-body code { background: #2d2d2d !important; }
        .markdown-body pre { background: #1e1e1e !important; }

        /* Console Panel */
        .console-input-wrap { display: flex; padding: 5px 10px; border-top: 1px solid var(--border); }
        .console-input { flex: 1; background: transparent; border: none; color: var(--text); font-family: monospace; font-size: 13px; }
        .console-input:focus { outline: none; }
        .console-output { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        .console-line { padding: 2px 0; border-bottom: 1px solid var(--border); }
        .console-line.error { color: #f85149; }
        .console-line.warn { color: #d29922; }
        .console-line.info { color: #58a6ff; }

        /* API Tester */
        .api-tester { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .api-method-select { width: 100px; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 4px; }
        .api-url-input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 4px; }
        .api-response { flex: 1; background: #1e1e1e; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 12px; overflow: auto; white-space: pre-wrap; }

        /* Color Picker */
        .color-preview { display: inline-block; width: 14px; height: 14px; border-radius: 2px; border: 1px solid #555; vertical-align: middle; margin-right: 4px; cursor: pointer; }

        /* Breakpoints */
        .breakpoint-gutter { width: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .breakpoint { width: 12px; height: 12px; background: #f85149; border-radius: 50%; }

        /* Diff View */
        .diff-container { display: flex; flex: 1; overflow: hidden; }
        .diff-pane { flex: 1; overflow: auto; }
        .diff-line { display: flex; font-family: monospace; font-size: 13px; }
        .diff-line-num { width: 40px; text-align: right; padding-right: 10px; color: var(--text2); user-select: none; }
        .diff-line-content { flex: 1; padding: 0 10px; }
        .diff-line.added { background: rgba(63, 185, 80, 0.15); }
        .diff-line.added .diff-line-content { border-left: 3px solid #3fb950; }
        .diff-line.removed { background: rgba(248, 81, 73, 0.15); }
        .diff-line.removed .diff-line-content { border-left: 3px solid #f85149; }

        /* Voice Input */
        .voice-btn { background: transparent; border: none; color: var(--text); cursor: pointer; padding: 5px; border-radius: 4px; }
        .voice-btn:hover { background: var(--hover); }
        .voice-btn.recording { color: #f85149; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Settings Panel */
        .settings-panel { display: flex; flex: 1; overflow: hidden; }
        .settings-nav { width: 200px; border-right: 1px solid var(--border); padding: 10px 0; }
        .settings-nav-item { padding: 8px 15px; cursor: pointer; }
        .settings-nav-item:hover { background: var(--hover); }
        .settings-nav-item.active { background: var(--selection); border-left: 2px solid var(--accent); }
        .settings-content { flex: 1; padding: 20px; overflow-y: auto; }
        .setting-item { margin-bottom: 20px; }
        .setting-title { font-weight: 600; margin-bottom: 5px; }
        .setting-desc { font-size: 12px; color: var(--text2); margin-bottom: 8px; }
        .setting-control { display: flex; gap: 10px; align-items: center; }
        .toggle-switch { width: 40px; height: 20px; background: #555; border-radius: 10px; position: relative; cursor: pointer; }
        .toggle-switch.on { background: var(--accent); }
        .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s; }
        .toggle-switch.on::after { left: 22px; }

        /* File System Access */
        .real-folder-btn { display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: var(--accent); border: none; color: white; border-radius: 4px; cursor: pointer; margin: 10px; }
        .real-folder-btn:hover { background: #026ec1; }

        /* Multi Terminal */
        .terminal-tabs { display: flex; background: var(--sidebar); border-bottom: 1px solid var(--border); }
        .terminal-tab { padding: 5px 15px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 12px; border-right: 1px solid var(--border); }
        .terminal-tab.active { background: var(--bg); }
        .terminal-tab-close { opacity: 0; }
        .terminal-tab:hover .terminal-tab-close { opacity: 1; }

        /* Image Drop Zone */
        .image-drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; margin: 10px 0; transition: 0.2s; }
        .image-drop-zone.dragover { border-color: var(--accent); background: rgba(0, 120, 212, 0.1); }
        .image-preview { max-width: 100%; max-height: 200px; border-radius: 4px; margin-top: 10px; }

        /* Install PWA Banner */
        .pwa-banner { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--sidebar); border: 1px solid var(--border); padding: 15px 25px; border-radius: 8px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; }
        .pwa-banner.hidden { display: none; }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Ctrl+K Inline Edit Modal -->
    <div id="inlineEditModal" class="modal">
        <div class="inline-edit-box">
            <div class="inline-edit-header">
                <span>‚ú® Edit with AI</span>
                <span class="inline-edit-file" id="inlineEditFile"></span>
            </div>
            <input type="text" id="inlineEditInput" class="inline-edit-input" placeholder="Describe what to change...">
            <div class="inline-edit-preview" id="inlineEditPreview">
                <div class="diff-header">
                    <span class="diff-old">Original</span>
                    <span class="diff-new">Modified</span>
                </div>
                <div class="diff-content" id="diffContent"></div>
            </div>
            <div class="inline-edit-actions" id="inlineEditActions" style="display:none">
                <button class="btn secondary" onclick="rejectInlineEdit()">‚úó Reject</button>
                <button class="btn" onclick="acceptInlineEdit()">‚úì Accept</button>
            </div>
        </div>
    </div>

    <!-- Go to Line Modal -->
    <div id="gotoLineModal" class="modal">
        <div class="palette-box" style="width:300px">
            <input type="text" id="gotoLineInput" class="palette-input" placeholder="Go to line number...">
        </div>
    </div>

    <!-- Symbol Search Modal -->
    <div id="symbolModal" class="modal">
        <div class="palette-box">
            <input type="text" id="symbolInput" class="palette-input" placeholder="Go to symbol...">
            <div id="symbolList" class="palette-list"></div>
        </div>
    </div>

    <!-- Command Palette Modal -->
    <div id="paletteModal" class="modal">
        <div class="palette-box">
            <input type="text" id="paletteInput" class="palette-input" placeholder="Type a command or search...">
            <div id="paletteList" class="palette-list"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <span>Settings</span>
                <i class="codicon codicon-close" style="cursor:pointer" onclick="closeModal()"></i>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">OpenRouter API Key</label>
                    <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-or-...">
                </div>
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <select id="themeSelect" class="form-input" onchange="setTheme(this.value)">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div id="newFileModal" class="modal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-header">
                <span id="newFileTitle">New File</span>
                <i class="codicon codicon-close" style="cursor:pointer" onclick="closeModal()"></i>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="newFileName" class="form-input" placeholder="filename.js">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="confirmNewFile()">Create</button>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div id="importExportModal" class="modal">
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <span>Import / Export Project</span>
                <i class="codicon codicon-close" style="cursor:pointer" onclick="closeModal()"></i>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="exportProject()" style="flex:1"><i class="codicon codicon-cloud-download"></i> Export as JSON</button>
                    <button class="btn secondary" onclick="document.getElementById('importFile').click()" style="flex:1"><i class="codicon codicon-cloud-upload"></i> Import JSON</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importProject(event)">
                </div>
                <div style="color: var(--text2); font-size: 12px;">
                    Export saves all your files. Import replaces all current files.
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu" style="display:none;"></div>

    <div class="main">
        <!-- Activity Bar -->
        <div class="activity">
            <div class="act-item active" data-view="explorer" title="Explorer (Ctrl+Shift+E)"><i class="codicon codicon-files"></i></div>
            <div class="act-item" data-view="search" title="Search (Ctrl+Shift+F)"><i class="codicon codicon-search"></i></div>
            <div class="act-item" data-view="git" title="Source Control (Ctrl+Shift+G)"><i class="codicon codicon-source-control"></i><span class="badge" id="gitBadge" style="display:none">0</span></div>
            <div class="act-item" data-view="outline" title="Outline (Ctrl+Shift+O)"><i class="codicon codicon-symbol-class"></i></div>
            <div class="act-item" data-view="history" title="File History"><i class="codicon codicon-history"></i></div>
            <div style="flex:1"></div>
            <div class="act-item" onclick="toggleZenMode()" title="Zen Mode (Ctrl+K Z)"><i class="codicon codicon-screen-full"></i></div>
            <div class="act-item active" id="aiToggleBtn" onclick="toggleAI()" title="AI Chat (Ctrl+L)"><i class="codicon codicon-hubot"></i></div>
            <div class="act-item" id="previewToggleBtn" onclick="togglePreview()" title="Toggle Preview"><i class="codicon codicon-open-preview"></i></div>
            <div class="act-item" onclick="openSettings()" title="Settings (Ctrl+,)"><i class="codicon codicon-settings-gear"></i></div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Explorer View -->
            <div id="view-explorer" class="sidebar-view active">
                <div class="side-header">
                    <span id="folderName">EXPLORER</span>
                    <div class="side-actions">
                        <i class="codicon codicon-new-file" title="New File" onclick="showNewFileModal('file')"></i>
                        <i class="codicon codicon-new-folder" title="New Folder" onclick="showNewFileModal('folder')"></i>
                        <i class="codicon codicon-refresh" title="Refresh" onclick="queueRender('tree')"></i>
                        <i class="codicon codicon-collapse-all" title="Collapse All"></i>
                    </div>
                </div>
                <button class="real-folder-btn" onclick="openRealFolder()" title="Open folder from your computer">
                    <i class="codicon codicon-folder-opened"></i> Open Real Folder
                </button>
                <div id="fileTree" class="file-tree"></div>
            </div>

            <!-- Search View -->
            <div id="view-search" class="sidebar-view">
                <div class="side-header"><span>SEARCH</span></div>
                <div class="search-box">
                    <input type="text" id="globalSearchInput" class="search-input" placeholder="Search in files...">
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <!-- Git View -->
            <div id="view-git" class="sidebar-view">
                <div class="side-header"><span>SOURCE CONTROL</span></div>
                <div id="gitContent">
                    <div class="git-section">
                        <div class="git-section-title"><i class="codicon codicon-git-commit"></i> Changes</div>
                        <div id="gitChanges"></div>
                    </div>
                </div>
            </div>

            <!-- Outline View -->
            <div id="view-outline" class="sidebar-view">
                <div class="side-header"><span>OUTLINE</span></div>
                <div id="outlineContent" class="file-tree"></div>
            </div>

            <!-- History View -->
            <div id="view-history" class="sidebar-view">
                <div class="side-header"><span>FILE HISTORY</span></div>
                <div id="historyContent" class="file-tree"></div>
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="resize-h" id="rSidebar"></div>

        <!-- Editor Area -->
        <div class="editor-wrap" id="editorWrap">
            <div class="tabs" id="tabsBar"></div>
            <div class="breadcrumbs" id="breadcrumbs"></div>
            
            <div class="editors-container">
                <div class="editor-pane" id="editorPane1">
                    <div id="monaco" class="editor-content"></div>
                    <div id="emptyEditor" class="empty-editor">
                        <div style="font-size: 2em; opacity: 0.5;">Cursor Clone Ultimate</div>
                        <div class="shortcuts">
                            <div class="shortcut" onclick="openPalette()"><div class="label">Command Palette</div><div><span class="key">Ctrl</span>+<span class="key">Shift</span>+<span class="key">P</span></div></div>
                            <div class="shortcut" onclick="openQuickOpen()"><div class="label">Quick Open</div><div><span class="key">Ctrl</span>+<span class="key">P</span></div></div>
                            <div class="shortcut" onclick="activateView('search')"><div class="label">Search Files</div><div><span class="key">Ctrl</span>+<span class="key">Shift</span>+<span class="key">F</span></div></div>
                            <div class="shortcut" onclick="togglePanel()"><div class="label">Toggle Terminal</div><div><span class="key">Ctrl</span>+<span class="key">`</span></div></div>
                        </div>
                        <button class="btn" onclick="showImportExport()" style="margin-top: 20px;"><i class="codicon codicon-folder-opened"></i> Open or Import Project</button>
                    </div>
                </div>
                
                <!-- Preview Pane -->
                <div class="preview-pane" id="previewPane">
                    <div class="preview-header">
                        <span>Preview</span>
                        <i class="codicon codicon-refresh" onclick="updatePreview()" style="cursor:pointer" title="Refresh"></i>
                    </div>
                    <iframe id="previewFrame"></iframe>
                </div>
            </div>

            <!-- Resize Handle -->
            <div class="resize-v" id="rPanel"></div>

            <!-- Bottom Panel -->
            <div class="bottom-panel" id="bottomPanel">
                <div class="panel-header">
                    <div class="panel-tab active" data-panel="terminal" onclick="switchPanel('terminal')">TERMINAL</div>
                    <div class="panel-tab" data-panel="problems" onclick="switchPanel('problems')">PROBLEMS <span class="count" id="problemsCount">0</span></div>
                    <div class="panel-tab" data-panel="output" onclick="switchPanel('output')">OUTPUT</div>
                    <div class="panel-tab" data-panel="console" onclick="switchPanel('console')">CONSOLE</div>
                    <div class="panel-tab" data-panel="api" onclick="switchPanel('api')">API TESTER</div>
                    <div style="flex:1"></div>
                    <div class="panel-tab" onclick="togglePanel()"><i class="codicon codicon-chevron-down"></i></div>
                </div>
                <div id="panelTerminal" class="panel-body active">
                    <div class="terminal-tabs" id="terminalTabs">
                        <div class="terminal-tab active" data-id="0">
                            <i class="codicon codicon-terminal"></i>
                            <span>bash</span>
                            <i class="codicon codicon-close terminal-tab-close" onclick="closeTerminal(0, event)"></i>
                        </div>
                        <div class="terminal-tab" onclick="addNewTerminal()" style="padding:5px 10px;">
                            <i class="codicon codicon-plus"></i>
                        </div>
                    </div>
                    <div id="termContainer" class="term-wrap"></div>
                </div>
                <div id="panelProblems" class="panel-body">
                    <div id="problemsList" class="problems-list"></div>
                </div>
                <div id="panelOutput" class="panel-body" style="padding:10px;color:var(--text2);overflow-y:auto;">
                    <div id="outputContent">[System] Cursor Clone Ultimate Max initialized.</div>
                </div>
                <div id="panelConsole" class="panel-body">
                    <div id="consoleOutput" class="console-output"></div>
                    <div class="console-input-wrap">
                        <span style="color:var(--accent);margin-right:5px;">></span>
                        <input type="text" id="consoleInput" class="console-input" placeholder="Evaluate JavaScript...">
                    </div>
                </div>
                <div id="panelApi" class="panel-body">
                    <div class="api-tester">
                        <div style="display:flex;gap:10px;">
                            <select id="apiMethod" class="api-method-select">
                                <option>GET</option>
                                <option>POST</option>
                                <option>PUT</option>
                                <option>DELETE</option>
                                <option>PATCH</option>
                            </select>
                            <input type="text" id="apiUrl" class="api-url-input" placeholder="https://api.example.com/endpoint">
                            <button class="btn" onclick="sendApiRequest()">Send</button>
                        </div>
                        <textarea id="apiBody" class="form-input" placeholder="Request body (JSON)" style="height:80px;font-family:monospace;display:none;"></textarea>
                        <div id="apiResponse" class="api-response">Response will appear here...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resize Handle -->
        <div class="resize-h" id="rAI"></div>

        <!-- AI Sidebar -->
        <div class="ai-side" id="aiSide">
            <div class="ai-header">
                <span>AI Chat</span>
                <div style="display:flex;gap:5px;">
                    <i class="codicon codicon-clear-all" title="Clear Chat" onclick="clearChat()"></i>
                    <i class="codicon codicon-close" title="Close" onclick="toggleAI()"></i>
                </div>
            </div>
            <div class="chat-area" id="chatArea">
                <div class="msg ai">
                    <div class="msg-header"><i class="codicon codicon-hubot"></i> Cursor AI</div>
                    Welcome! I can help you with your code. Use <strong>@filename</strong> to reference specific files.
                </div>
            </div>
            <div class="ai-input-wrap">
                <div class="agent-selector" id="agentSelector">
                    <button class="agent-btn active" data-agent="default" onclick="selectAgent('default')">üí¨ Chat</button>
                    <button class="agent-btn" data-agent="review" onclick="selectAgent('review')">üîç Review</button>
                    <button class="agent-btn" data-agent="debug" onclick="selectAgent('debug')">üêõ Debug</button>
                    <button class="agent-btn" data-agent="refactor" onclick="selectAgent('refactor')">‚ú® Refactor</button>
                    <button class="agent-btn" data-agent="docs" onclick="selectAgent('docs')">üìù Docs</button>
                </div>
                <div class="model-row">
                    <select id="modelSelect" class="model-select"></select>
                </div>
                <div id="imageDropZone" class="image-drop-zone hidden">
                    <i class="codicon codicon-file-media"></i> Drop image here or paste screenshot
                    <img id="imagePreview" class="image-preview hidden">
                </div>
                <div class="ai-input-container">
                    <div id="mentionsDropdown" class="mentions-dropdown"></div>
                    <textarea id="aiInput" class="ai-input" placeholder="Ask about your code... (@ to mention, paste image, or use voice)"></textarea>
                    <div style="position:absolute;right:70px;bottom:10px;display:flex;gap:5px;">
                        <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceInput()" title="Voice Input"><i class="codicon codicon-mic"></i></button>
                        <button class="voice-btn" onclick="toggleImageDrop()" title="Attach Image"><i class="codicon codicon-file-media"></i></button>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status">
        <div class="status-left">
            <div class="status-item"><i class="codicon codicon-source-control"></i> main</div>
            <div class="status-item" id="statusProblems"><i class="codicon codicon-error"></i> 0 <i class="codicon codicon-warning"></i> 0</div>
        </div>
        <div class="status-right">
            <div class="status-item" id="cursorPos">Ln 1, Col 1</div>
            <div class="status-item" id="langStatus">Plain Text</div>
            <div class="status-item" id="encodingStatus">UTF-8</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12/lib/marked.umd.min.js"></script>
    <!-- WebContainers for real Node.js -->
    <script type="module">
        import { WebContainer } from 'https://cdn.jsdelivr.net/npm/@aspect-runtime/web-container/+esm';
        window.WebContainer = WebContainer;
    </script>

    <script>
    // ==================== CONFIGURATION ====================
    const DEFAULT_API_KEY = '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';
    let apiKey = localStorage.getItem('apiKey') || DEFAULT_API_KEY;
    
    const MODELS = [
        { id: 'anthropic/claude-3.5-sonnet', name: '‚≠ê Claude 3.5 Sonnet' },
        { id: 'anthropic/claude-3-opus', name: 'Claude 3 Opus' },
        { id: 'openai/gpt-4o', name: 'GPT-4o' },
        { id: 'openai/gpt-4-turbo', name: 'GPT-4 Turbo' },
        { id: 'google/gemini-pro-1.5', name: 'Gemini Pro 1.5' },
        { id: 'mistralai/mistral-large', name: 'Mistral Large' },
        { id: 'meta-llama/llama-3.1-405b-instruct', name: 'Llama 3.1 405B' },
        { id: 'deepseek/deepseek-coder', name: 'DeepSeek Coder' }
    ];

    const FILE_ICONS = {
        'html': 'üåê', 'htm': 'üåê',
        'css': 'üé®', 'scss': 'üé®', 'sass': 'üé®', 'less': 'üé®',
        'js': '‚ö°', 'jsx': '‚öõÔ∏è', 'ts': 'üí†', 'tsx': '‚öõÔ∏è',
        'json': 'üìã', 'xml': 'üìÑ',
        'md': 'üìù', 'txt': 'üìÑ',
        'py': 'üêç', 'rb': 'üíé', 'php': 'üêò',
        'java': '‚òï', 'c': 'üîß', 'cpp': 'üîß', 'h': 'üìé',
        'go': 'üêπ', 'rs': 'ü¶Ä', 'swift': 'üçé',
        'sh': 'üñ•Ô∏è', 'bash': 'üñ•Ô∏è', 'zsh': 'üñ•Ô∏è',
        'sql': 'üóÉÔ∏è', 'graphql': '‚óºÔ∏è',
        'yml': '‚öôÔ∏è', 'yaml': '‚öôÔ∏è', 'toml': '‚öôÔ∏è',
        'env': 'üîê', 'gitignore': 'üì¶',
        'svg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
        'folder': 'üìÅ', 'folder-open': 'üìÇ'
    };

    // ==================== STATE ====================
    let VFS = JSON.parse(localStorage.getItem('vfs')) || {
        'index.html': { type: 'file', content: '<!DOCTYPE html>\n<html>\n<head>\n  <title>My App</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div class="container">\n    <h1>Hello World!</h1>\n    <p>Welcome to my app.</p>\n    <button id="btn">Click Me</button>\n  </div>\n  <script src="app.js"><\/script>\n</body>\n</html>', modified: false },
        'style.css': { type: 'file', content: '* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: system-ui, sans-serif;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  min-height: 100vh;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.container {\n  background: white;\n  padding: 40px;\n  border-radius: 16px;\n  box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n  text-align: center;\n}\n\nh1 {\n  color: #333;\n  margin-bottom: 10px;\n}\n\np {\n  color: #666;\n  margin-bottom: 20px;\n}\n\nbutton {\n  background: #667eea;\n  color: white;\n  border: none;\n  padding: 12px 30px;\n  font-size: 16px;\n  border-radius: 8px;\n  cursor: pointer;\n  transition: transform 0.2s, box-shadow 0.2s;\n}\n\nbutton:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);\n}', modified: false },
        'app.js': { type: 'file', content: '// Main application logic\nconst btn = document.getElementById("btn");\nlet clickCount = 0;\n\nbtn.addEventListener("click", () => {\n  clickCount++;\n  btn.textContent = `Clicked ${clickCount} times!`;\n  console.log("Button clicked:", clickCount);\n});\n\n// Log when page loads\nconsole.log("App initialized!");', modified: false },
        'README.md': { type: 'file', content: '# My Project\n\nA simple web application.\n\n## Features\n\n- Modern CSS styling\n- Interactive JavaScript\n- Clean HTML structure\n\n## Getting Started\n\n1. Open index.html in a browser\n2. Click the button\n3. Have fun!\n\n## License\n\nMIT', modified: false }
    };

    let editor = null;
    let term = null;
    let fitAddon = null;
    let activeFile = null;
    let openFiles = [];
    let conversationHistory = [];
    let cmdBuffer = '';
    let cmdHistory = [];
    let cmdHistoryIndex = -1;
    let isStreaming = false;
    let currentMentions = [];
    let renderQueue = new Set();
    let renderTimeout = null;
    let sortedFileList = null;
    let fileListCacheKey = null;

    // ==================== UTILITIES ====================
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function queueRender(type) {
        renderQueue.add(type);
        if (renderTimeout) clearTimeout(renderTimeout);
        renderTimeout = setTimeout(() => {
            renderQueue.forEach(renderType => {
                if (renderType === 'tree') renderTree();
                else if (renderType === 'tabs') renderTabs();
            });
            renderQueue.clear();
            renderTimeout = null;
        }, 0);
    }

    function getSortedFiles() {
        const currentKeys = Object.keys(VFS).sort().join(',');
        if (fileListCacheKey !== currentKeys) {
            fileListCacheKey = currentKeys;
            sortedFileList = Object.keys(VFS).sort((a, b) => {
                const aIsFolder = VFS[a].type === 'folder';
                const bIsFolder = VFS[b].type === 'folder';
                if (aIsFolder && !bIsFolder) return -1;
                if (!aIsFolder && bIsFolder) return 1;
                return a.localeCompare(b);
            });
        }
        return sortedFileList;
    }

    function invalidateFileCache() {
        fileListCacheKey = null;
        sortedFileList = null;
    }

    // ==================== INITIALIZATION ====================
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });

    window.onload = () => {
        populateModels();
        initShortcuts();
        initActivityBar();
        initResizers();
        queueRender('tree');
        updateGitPanel();
        
        // Wait for xterm
        waitFor(() => typeof Terminal !== 'undefined', initTerminal);
        
        // Load theme
        const theme = localStorage.getItem('theme') || 'dark';
        setTheme(theme);
        
        // Show toast
        toast('Cursor Clone Ultimate loaded!', 'success');
    };

    function waitFor(condition, callback, maxAttempts = 50) {
        let attempts = 0;
        const check = () => {
            if (condition()) callback();
            else if (++attempts < maxAttempts) setTimeout(check, 100);
        };
        check();
    }

    // ==================== TOAST NOTIFICATIONS ====================
    function toast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<i class="codicon codicon-${type === 'success' ? 'check' : type === 'error' ? 'error' : 'info'}"></i> ${message}`;
        container.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // ==================== THEME ====================
    function setTheme(theme) {
        document.body.classList.toggle('theme-light', theme === 'light');
        localStorage.setItem('theme', theme);
        document.getElementById('themeSelect').value = theme;
        if (editor) {
            monaco.editor.setTheme(theme === 'light' ? 'vs' : 'vs-dark');
        }
    }

    // ==================== SHORTCUTS ====================
    function initShortcuts() {
        document.addEventListener('keydown', e => {
            // Command Palette
            if (e.ctrlKey && e.shiftKey && e.key === 'P') { e.preventDefault(); openPalette(); }
            // Quick Open
            if (e.ctrlKey && e.key === 'p' && !e.shiftKey) { e.preventDefault(); openQuickOpen(); }
            // Toggle Terminal
            if (e.ctrlKey && e.key === '`') { e.preventDefault(); togglePanel(); }
            // Save
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveFile(); }
            // Search
            if (e.ctrlKey && e.shiftKey && e.key === 'F') { e.preventDefault(); activateView('search'); }
            // AI Focus
            if (e.ctrlKey && e.key === 'l') { e.preventDefault(); document.getElementById('aiInput').focus(); }
            // Close modal on Escape
            if (e.key === 'Escape') closeModal();
        });

        // AI Input handlers
        const aiInput = document.getElementById('aiInput');
        const debouncedMentionInput = debounce(handleMentionInput, 150);
        aiInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
            if (e.key === '@') setTimeout(() => showMentions(), 0);
        });
        aiInput.addEventListener('input', debouncedMentionInput);

        // Search input handler with debouncing
        const globalSearchInput = document.getElementById('globalSearchInput');
        const debouncedGlobalSearch = debounce((value) => globalSearch(value), 200);
        globalSearchInput.addEventListener('input', (e) => debouncedGlobalSearch(e.target.value));
    }

    // ==================== ACTIVITY BAR ====================
    function initActivityBar() {
        document.querySelectorAll('.act-item[data-view]').forEach(item => {
            item.onclick = () => activateView(item.dataset.view);
        });
    }

    function activateView(viewName) {
        document.querySelectorAll('.act-item[data-view]').forEach(i => i.classList.remove('active'));
        document.querySelector(`.act-item[data-view="${viewName}"]`)?.classList.add('active');
        document.querySelectorAll('.sidebar-view').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${viewName}`)?.classList.add('active');
        if (viewName === 'search') document.getElementById('globalSearchInput').focus();
    }

    // ==================== RESIZERS ====================
    function initResizers() {
        makeResizable('rSidebar', 'sidebar', 'width', 150, 500);
        makeResizable('rAI', 'aiSide', 'width', 280, 700, true);
        makeResizable('rPanel', 'bottomPanel', 'height', 35, window.innerHeight * 0.7, true);
    }

    function makeResizable(resizerId, targetId, prop, min, max, inverse = false) {
        const resizer = document.getElementById(resizerId);
        const target = document.getElementById(targetId);
        let startPos, startSize;

        resizer.addEventListener('mousedown', e => {
            e.preventDefault();
            startPos = prop === 'width' ? e.clientX : e.clientY;
            startSize = target.getBoundingClientRect()[prop];
            document.body.style.cursor = prop === 'width' ? 'col-resize' : 'row-resize';
            resizer.classList.add('resizing');

            const onMove = e => {
                let delta = (prop === 'width' ? e.clientX : e.clientY) - startPos;
                if (inverse) delta = -delta;
                target.style[prop] = Math.max(min, Math.min(max, startSize + delta)) + 'px';
                if (editor) editor.layout();
                if (fitAddon) try { fitAddon.fit(); } catch(e) {}
            };

            const onUp = () => {
                document.body.style.cursor = '';
                resizer.classList.remove('resizing');
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            };

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });
    }

    // ==================== FILE SYSTEM ====================
    function getFileIcon(name, isFolder = false) {
        if (isFolder) return FILE_ICONS['folder'];
        const ext = name.split('.').pop().toLowerCase();
        return FILE_ICONS[ext] || 'üìÑ';
    }

    function renderTree() {
        const tree = document.getElementById('fileTree');
        const files = getSortedFiles();

        // Clear existing content efficiently
        tree.textContent = '';

        // Create document fragment for batch DOM insertion
        const fragment = document.createDocumentFragment();

        files.forEach(name => {
            const file = VFS[name];
            const isFolder = file.type === 'folder';
            const isActive = name === activeFile;

            const item = document.createElement('div');
            item.className = `tree-item ${isFolder ? 'folder' : ''} ${isActive ? 'active' : ''}`;
            item.dataset.name = name;

            const iconSpan = document.createElement('span');
            iconSpan.className = 'file-icon';
            iconSpan.textContent = getFileIcon(name, isFolder);
            item.appendChild(iconSpan);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = name;
            item.appendChild(nameSpan);

            if (file.modified) {
                const modifiedSpan = document.createElement('span');
                modifiedSpan.className = 'modified';
                item.appendChild(modifiedSpan);
            }

            fragment.appendChild(item);
        });

        tree.appendChild(fragment);
        updateGitPanel();
    }

    // Event delegation for file tree
    document.getElementById('fileTree').addEventListener('click', (e) => {
        const item = e.target.closest('.tree-item');
        if (!item) return;

        const fileName = item.dataset.name;
        const file = VFS[fileName];
        if (file && file.type !== 'folder') {
            openFile(fileName);
        }
    });

    document.getElementById('fileTree').addEventListener('contextmenu', (e) => {
        const item = e.target.closest('.tree-item');
        if (!item) return;

        e.preventDefault();
        const fileName = item.dataset.name;
        showContextMenu(e, fileName);
    });

    function showNewFileModal(type) {
        document.getElementById('newFileTitle').textContent = type === 'folder' ? 'New Folder' : 'New File';
        document.getElementById('newFileName').value = '';
        document.getElementById('newFileName').dataset.type = type;
        document.getElementById('newFileModal').classList.add('open');
        setTimeout(() => document.getElementById('newFileName').focus(), 100);
    }

    function confirmNewFile() {
        const input = document.getElementById('newFileName');
        const name = input.value.trim();
        const type = input.dataset.type;
        
        if (!name) return toast('Please enter a name', 'error');
        if (VFS[name]) return toast('File already exists', 'error');

        if (type === 'folder') {
            VFS[name] = { type: 'folder' };
        } else {
            const ext = name.split('.').pop().toLowerCase();
            const langMap = { js: 'javascript', ts: 'typescript', html: 'html', css: 'css', md: 'markdown', json: 'json', py: 'python' };
            VFS[name] = { type: 'file', content: '', lang: langMap[ext] || 'plaintext', modified: false };
        }

        saveToLocalStorage();
        invalidateFileCache();
        queueRender('tree');
        closeModal();
        toast(`${type === 'folder' ? 'Folder' : 'File'} created: ${name}`, 'success');
        
        if (type !== 'folder') openFile(name);
    }

    function deleteFile(name) {
        if (!confirm(`Delete "${name}"?`)) return;
        delete VFS[name];
        openFiles = openFiles.filter(f => f !== name);
        if (activeFile === name) activeFile = openFiles[0] || null;
        saveToLocalStorage();
        invalidateFileCache();
        queueRender('tree');
        queueRender('tabs');
        if (activeFile) openFile(activeFile);
        else showEmptyEditor();
        toast(`Deleted: ${name}`, 'info');
    }

    function renameFile(oldName) {
        const newName = prompt('New name:', oldName);
        if (!newName || newName === oldName) return;
        if (VFS[newName]) return toast('File already exists', 'error');
        
        VFS[newName] = VFS[oldName];
        delete VFS[oldName];
        
        const idx = openFiles.indexOf(oldName);
        if (idx !== -1) openFiles[idx] = newName;
        if (activeFile === oldName) activeFile = newName;

        saveToLocalStorage();
        invalidateFileCache();
        queueRender('tree');
        queueRender('tabs');
        toast(`Renamed to: ${newName}`, 'success');
    }

    function showContextMenu(e, name) {
        e.preventDefault();
        const menu = document.getElementById('contextMenu');
        const isFolder = VFS[name]?.type === 'folder';
        
        menu.innerHTML = `
            ${!isFolder ? `<div class="context-menu-item" onclick="openFile('${name}'); hideContextMenu()"><i class="codicon codicon-file"></i> Open</div>` : ''}
            <div class="context-menu-item" onclick="renameFile('${name}'); hideContextMenu()"><i class="codicon codicon-edit"></i> Rename</div>
            <div class="context-menu-item" onclick="deleteFile('${name}'); hideContextMenu()"><i class="codicon codicon-trash"></i> Delete</div>
            <div class="context-menu-sep"></div>
            <div class="context-menu-item" onclick="copyFileName('${name}'); hideContextMenu()"><i class="codicon codicon-copy"></i> Copy Name</div>
        `;
        
        menu.style.left = e.clientX + 'px';
        menu.style.top = e.clientY + 'px';
        menu.style.display = 'block';
        
        document.addEventListener('click', hideContextMenu, { once: true });
    }

    function hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
    }

    function copyFileName(name) {
        navigator.clipboard.writeText(name);
        toast('Copied to clipboard', 'success');
    }

    // ==================== EDITOR ====================
    function openFile(filename) {
        if (!VFS[filename] || VFS[filename].type === 'folder') return;

        activeFile = filename;
        if (!openFiles.includes(filename)) openFiles.push(filename);

        queueRender('tabs');
        queueRender('tree');
        updateBreadcrumbs();
        document.getElementById('emptyEditor').classList.add('hidden');
        document.getElementById('monaco').style.display = 'block';

        const file = VFS[filename];
        const ext = filename.split('.').pop().toLowerCase();
        const langMap = { js: 'javascript', jsx: 'javascript', ts: 'typescript', tsx: 'typescript', html: 'html', css: 'css', scss: 'scss', md: 'markdown', json: 'json', py: 'python', rb: 'ruby', go: 'go', rs: 'rust', java: 'java', c: 'c', cpp: 'cpp', h: 'c', php: 'php', sql: 'sql', sh: 'shell', yml: 'yaml', yaml: 'yaml', xml: 'xml' };
        const lang = langMap[ext] || 'plaintext';

        document.getElementById('langStatus').textContent = lang.toUpperCase();

        require(['vs/editor/editor.main'], () => {
            if (editor) editor.dispose();

            editor = monaco.editor.create(document.getElementById('monaco'), {
                value: file.content,
                language: lang,
                theme: document.body.classList.contains('theme-light') ? 'vs' : 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                wordWrap: 'on',
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                bracketPairColorization: { enabled: true }
            });

            editor.onDidChangeCursorPosition(e => {
                document.getElementById('cursorPos').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
            });

            editor.onDidChangeModelContent(() => {
                VFS[activeFile].content = editor.getValue();
                VFS[activeFile].modified = true;
                queueRender('tabs');
                updatePreview();
            });

            // Find command
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyF, () => {
                editor.getAction('actions.find').run();
            });

            // Replace command  
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyH, () => {
                editor.getAction('editor.action.startFindReplaceAction').run();
            });
        });

        updatePreview();
        updateOutline();
        updateHistoryView();
    }

    function showEmptyEditor() {
        document.getElementById('monaco').style.display = 'none';
        document.getElementById('emptyEditor').classList.remove('hidden');
        if (editor) { editor.dispose(); editor = null; }
    }

    function renderTabs() {
        const tabsBar = document.getElementById('tabsBar');

        // Clear existing content efficiently
        tabsBar.textContent = '';

        // Create document fragment for batch DOM insertion
        const fragment = document.createDocumentFragment();

        openFiles.forEach(f => {
            const file = VFS[f];
            const tab = document.createElement('div');
            tab.className = `tab ${f === activeFile ? 'active' : 'inactive'}`;
            tab.dataset.filename = f;

            const iconSpan = document.createElement('span');
            iconSpan.className = 'file-icon';
            iconSpan.style.fontSize = '12px';
            iconSpan.textContent = getFileIcon(f);
            tab.appendChild(iconSpan);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = f;
            tab.appendChild(nameSpan);

            if (file?.modified) {
                const modifiedDot = document.createElement('span');
                modifiedDot.className = 'modified-dot';
                tab.appendChild(modifiedDot);
            }

            const closeIcon = document.createElement('i');
            closeIcon.className = 'codicon codicon-close tab-close';
            tab.appendChild(closeIcon);

            fragment.appendChild(tab);
        });

        tabsBar.appendChild(fragment);
    }

    // Event delegation for tabs
    document.getElementById('tabsBar').addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (!tab) return;

        const fileName = tab.dataset.filename;

        // Check if click was on close button
        if (e.target.closest('.tab-close')) {
            e.stopPropagation();
            closeFile(fileName);
            return;
        }

        // Open file
        openFile(fileName);
    });

    function closeFile(filename) {
        const wasActive = activeFile === filename;
        openFiles = openFiles.filter(f => f !== filename);
        
        if (wasActive) {
            activeFile = openFiles[openFiles.length - 1] || null;
        }

        queueRender('tabs');
        if (activeFile) openFile(activeFile);
        else showEmptyEditor();
    }

    function saveFile() {
        if (!activeFile) return;
        VFS[activeFile].modified = false;
        saveToLocalStorage();
        renderTabs();
        renderTree();
        toast(`Saved: ${activeFile}`, 'success');
    }

    function updateBreadcrumbs() {
        const bc = document.getElementById('breadcrumbs');
        if (!activeFile) {
            bc.innerHTML = '';
            return;
        }
        bc.innerHTML = `
            <span class="breadcrumb"><i class="codicon codicon-folder"></i> project</span>
            <span class="breadcrumb-sep">/</span>
            <span class="breadcrumb">${getFileIcon(activeFile)} ${activeFile}</span>
        `;
    }

    // ==================== PREVIEW ====================
    function togglePreview() {
        const pane = document.getElementById('previewPane');
        const btn = document.getElementById('previewToggleBtn');
        const isActive = pane.classList.toggle('active');
        btn.classList.toggle('active', isActive);
        if (isActive) updatePreview();
        if (editor) editor.layout();
    }

    function updatePreview() {
        const frame = document.getElementById('previewFrame');
        if (!document.getElementById('previewPane').classList.contains('active')) return;
        
        const html = VFS['index.html']?.content || '';
        let css = VFS['style.css']?.content || '';
        let js = VFS['app.js']?.content || '';
        
        const doc = `
            <!DOCTYPE html>
            <html>
            <head><style>${css}</style></head>
            <body>${html.replace(/<link[^>]*>/gi, '').replace(/<script[^>]*>.*?<\/script>/gi, '')}
            <script>${js}<\/script>
            </body>
            </html>
        `;
        
        frame.srcdoc = doc;
    }

    // ==================== SEARCH ====================
    function globalSearch(query) {
        const results = document.getElementById('searchResults');
        if (!query || query.length < 2) {
            results.innerHTML = '<div style="padding:15px;color:var(--text2)">Type at least 2 characters...</div>';
            return;
        }

        const matches = [];
        const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        
        Object.entries(VFS).forEach(([name, file]) => {
            if (file.type === 'folder') return;
            const lines = file.content.split('\n');
            lines.forEach((line, i) => {
                if (line.toLowerCase().includes(query.toLowerCase())) {
                    matches.push({ file: name, line: i + 1, content: line.trim(), query });
                }
            });
        });

        if (matches.length === 0) {
            results.innerHTML = '<div style="padding:15px;color:var(--text2)">No results found</div>';
            return;
        }

        results.innerHTML = matches.slice(0, 100).map(m => `
            <div class="search-result" onclick="openFile('${m.file}')">
                <div class="search-result-file">${getFileIcon(m.file)} ${m.file}:${m.line}</div>
                <div class="search-result-line">${escapeHtml(m.content).replace(new RegExp(m.query, 'gi'), '<span class="search-match">$&</span>')}</div>
            </div>
        `).join('');
    }

    // ==================== GIT PANEL ====================
    function updateGitPanel() {
        const changes = Object.entries(VFS).filter(([n, f]) => f.modified);
        document.getElementById('gitBadge').textContent = changes.length;
        document.getElementById('gitBadge').style.display = changes.length > 0 ? 'block' : 'none';
        
        document.getElementById('gitChanges').innerHTML = changes.length === 0 
            ? '<div style="padding:10px;color:var(--text2);font-size:12px">No changes</div>'
            : changes.map(([name]) => `
                <div class="git-file">
                    <span class="git-status M">M</span>
                    <span>${getFileIcon(name)} ${name}</span>
                </div>
            `).join('');
    }

    // ==================== TERMINAL ====================
    function initTerminal() {
        const container = document.getElementById('termContainer');
        container.innerHTML = '';

        term = new Terminal({
            theme: { background: '#0c0c0c', foreground: '#cccccc', cursor: '#ffffff' },
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Consolas, monospace',
            convertEol: true
        });

        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(container);
        setTimeout(() => fitAddon.fit(), 100);

        term.writeln('\x1b[1;36m‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\x1b[0m');
        term.writeln('\x1b[1;36m‚îÇ     Cursor Clone Terminal           ‚îÇ\x1b[0m');
        term.writeln('\x1b[1;36m‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\x1b[0m');
        term.writeln('Type \x1b[33mhelp\x1b[0m for commands.\n');
        prompt();

        term.onData(data => {
            const code = data.charCodeAt(0);
            
            if (data === '\r') {
                term.write('\r\n');
                if (cmdBuffer.trim()) cmdHistory.push(cmdBuffer.trim());
                cmdHistoryIndex = cmdHistory.length;
                execCommand(cmdBuffer.trim());
                cmdBuffer = '';
            } else if (data === '\u007F' || code === 8) {
                if (cmdBuffer.length > 0) {
                    cmdBuffer = cmdBuffer.slice(0, -1);
                    term.write('\b \b');
                }
            } else if (data === '\u001b[A') { // Up arrow
                if (cmdHistoryIndex > 0) {
                    clearLine();
                    cmdHistoryIndex--;
                    cmdBuffer = cmdHistory[cmdHistoryIndex] || '';
                    term.write(cmdBuffer);
                }
            } else if (data === '\u001b[B') { // Down arrow
                if (cmdHistoryIndex < cmdHistory.length) {
                    clearLine();
                    cmdHistoryIndex++;
                    cmdBuffer = cmdHistory[cmdHistoryIndex] || '';
                    term.write(cmdBuffer);
                }
            } else if (code >= 32 && code < 127) {
                cmdBuffer += data;
                term.write(data);
            }
        });

        container.addEventListener('click', () => term.focus());
        new ResizeObserver(() => { try { fitAddon.fit(); } catch(e) {} }).observe(container);
    }

    function clearLine() {
        term.write('\r\x1b[K');
        term.write('\x1b[33mPS>\x1b[0m ');
    }

    function prompt() {
        term.write('\x1b[33mPS>\x1b[0m ');
    }

    function execCommand(cmd) {
        if (!cmd) { prompt(); return; }
        const [command, ...args] = cmd.split(' ');
        
        const commands = {
            help: () => {
                term.writeln('\n\x1b[36mAvailable commands:\x1b[0m');
                term.writeln('  ls, dir     - List files');
                term.writeln('  cat <file>  - Show file content');
                term.writeln('  touch <file>- Create file');
                term.writeln('  rm <file>   - Delete file');
                term.writeln('  clear       - Clear terminal');
                term.writeln('  npm <cmd>   - Simulate npm');
                term.writeln('  git <cmd>   - Simulate git');
                term.writeln('');
            },
            ls: () => { term.writeln('\n' + Object.keys(VFS).map(f => `  ${getFileIcon(f)} ${f}`).join('\n') + '\n'); },
            dir: () => commands.ls(),
            cat: () => {
                if (VFS[args[0]]) term.writeln('\n' + VFS[args[0]].content + '\n');
                else term.writeln(`\x1b[31mFile not found: ${args[0]}\x1b[0m`);
            },
            touch: () => {
                if (args[0]) {
                    VFS[args[0]] = { type: 'file', content: '', modified: false };
                    saveToLocalStorage();
                    invalidateFileCache();
                    queueRender('tree');
                    term.writeln(`\x1b[32mCreated: ${args[0]}\x1b[0m`);
                }
            },
            rm: () => {
                if (VFS[args[0]]) {
                    delete VFS[args[0]];
                    saveToLocalStorage();
                    invalidateFileCache();
                    queueRender('tree');
                    term.writeln(`\x1b[32mDeleted: ${args[0]}\x1b[0m`);
                } else term.writeln(`\x1b[31mFile not found\x1b[0m`);
            },
            clear: () => term.clear(),
            npm: () => {
                if (args[0] === 'install' || args[0] === 'i') {
                    term.writeln('\n\x1b[32madded 127 packages in 2.3s\x1b[0m\n');
                } else if (args[0] === 'run' && args[1] === 'dev') {
                    term.writeln('\n> dev\n> vite\n\n\x1b[36mVITE ready at http://localhost:5173/\x1b[0m\n');
                } else term.writeln('\nUsage: npm install | npm run dev\n');
            },
            git: () => {
                if (args[0] === 'status') {
                    const modified = Object.entries(VFS).filter(([,f]) => f.modified);
                    term.writeln('\nOn branch main\n');
                    if (modified.length) {
                        term.writeln('Changes not staged:');
                        modified.forEach(([n]) => term.writeln(`  \x1b[31mmodified: ${n}\x1b[0m`));
                    } else term.writeln('nothing to commit');
                    term.writeln('');
                } else if (args[0] === 'add' && args[1] === '.') {
                    term.writeln('\x1b[32mAll files staged\x1b[0m');
                } else if (args[0] === 'commit') {
                    Object.values(VFS).forEach(f => f.modified = false);
                    saveToLocalStorage();
                    renderTree();
                    updateGitPanel();
                    term.writeln('\x1b[32m[main] Committed changes\x1b[0m');
                } else term.writeln('\nUsage: git status | git add . | git commit -m "msg"\n');
            }
        };

        if (commands[command.toLowerCase()]) commands[command.toLowerCase()]();
        else term.writeln(`\x1b[31mCommand not found: ${command}\x1b[0m`);
        
        prompt();
    }

    // ==================== PANELS ====================
    function switchPanel(panel) {
        document.querySelectorAll('.panel-tab[data-panel]').forEach(t => t.classList.remove('active'));
        document.querySelector(`.panel-tab[data-panel="${panel}"]`)?.classList.add('active');
        document.querySelectorAll('.panel-body').forEach(b => b.classList.remove('active'));
        document.getElementById('panel' + panel.charAt(0).toUpperCase() + panel.slice(1))?.classList.add('active');
        if (panel === 'terminal' && fitAddon) setTimeout(() => fitAddon.fit(), 50);
    }

    function togglePanel() {
        const panel = document.getElementById('bottomPanel');
        panel.classList.toggle('collapsed');
        if (!panel.classList.contains('collapsed') && fitAddon) setTimeout(() => fitAddon.fit(), 100);
    }

    // ==================== AI CHAT ====================
    function populateModels() {
        document.getElementById('modelSelect').innerHTML = MODELS.map(m => 
            `<option value="${m.id}">${m.name}</option>`
        ).join('');
    }

    // Mentions System
    function showMentions() {
        const dropdown = document.getElementById('mentionsDropdown');
        dropdown.classList.add('open');
        updateMentions('');
    }

    function updateMentions(filter) {
        const dropdown = document.getElementById('mentionsDropdown');
        const files = Object.keys(VFS).filter(f => 
            VFS[f].type !== 'folder' && f.toLowerCase().includes(filter.toLowerCase())
        );
        
        dropdown.innerHTML = files.slice(0, 10).map(f => `
            <div class="mention-item" onclick="insertMention('${f}')">
                <span>${getFileIcon(f)}</span>
                <span>${f}</span>
            </div>
        `).join('');
    }

    function handleMentionInput(e) {
        const input = e.target;
        const value = input.value;
        const cursorPos = input.selectionStart;
        
        // Find @mention
        const beforeCursor = value.slice(0, cursorPos);
        const match = beforeCursor.match(/@(\S*)$/);
        
        if (match) {
            updateMentions(match[1]);
            document.getElementById('mentionsDropdown').classList.add('open');
        } else {
            document.getElementById('mentionsDropdown').classList.remove('open');
        }
    }

    function insertMention(filename) {
        const input = document.getElementById('aiInput');
        const value = input.value;
        const cursorPos = input.selectionStart;
        const beforeCursor = value.slice(0, cursorPos);
        const afterCursor = value.slice(cursorPos);
        
        const newBefore = beforeCursor.replace(/@\S*$/, `@${filename} `);
        input.value = newBefore + afterCursor;
        input.focus();
        
        if (!currentMentions.includes(filename)) currentMentions.push(filename);
        
        document.getElementById('mentionsDropdown').classList.remove('open');
    }

    async function sendChat() {
        const input = document.getElementById('aiInput');
        const text = input.value.trim();
        if (!text || isStreaming) return;

        const area = document.getElementById('chatArea');
        const model = document.getElementById('modelSelect').value;
        
        // Extract @mentions
        const mentions = text.match(/@(\S+)/g)?.map(m => m.slice(1)).filter(f => VFS[f]) || [];
        currentMentions = [...new Set([...currentMentions, ...mentions])];
        
        // Add user message
        area.innerHTML += `
            <div class="msg user">
                ${currentMentions.length > 0 ? `<div class="msg-context">${currentMentions.map(f => `<span class="context-badge" onclick="openFile('${f}')">${getFileIcon(f)} ${f}</span>`).join('')}</div>` : ''}
                ${escapeHtml(text)}
            </div>
        `;
        input.value = '';

        // Create AI message container
        const msgId = 'msg-' + Date.now();
        area.innerHTML += `
            <div class="msg ai" id="${msgId}">
                <div class="msg-header"><i class="codicon codicon-hubot"></i> Cursor AI</div>
                <div class="msg-content">Thinking...</div>
            </div>
        `;
        area.scrollTop = area.scrollHeight;

        // Build context from mentioned files or all files
        const contextFiles = currentMentions.length > 0 ? currentMentions : Object.keys(VFS).filter(f => VFS[f].type !== 'folder');
        const context = contextFiles.map(f => `=== ${f} ===\n${VFS[f].content}`).join('\n\n');

        // Add to conversation history
        conversationHistory.push({ role: 'user', content: `Context:\n${context}\n\nQuestion: ${text}` });

        isStreaming = true;
        document.getElementById('sendBtn').disabled = true;

        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + apiKey,
                    'HTTP-Referer': location.href
                },
                body: JSON.stringify({
                    model,
                    messages: [
                        { role: 'system', content: agentPrompts[currentAgent] + ' Use markdown code blocks with language tags. When suggesting code changes, be specific about which file and where.' },
                        ...conversationHistory.slice(-10)
                    ],
                    stream: true
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullContent = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n').filter(l => l.startsWith('data: '));

                for (const line of lines) {
                    const data = line.slice(6);
                    if (data === '[DONE]') continue;
                    
                    try {
                        const json = JSON.parse(data);
                        const content = json.choices?.[0]?.delta?.content || '';
                        fullContent += content;
                        document.querySelector(`#${msgId} .msg-content`).innerHTML = formatAIResponse(fullContent);
                        area.scrollTop = area.scrollHeight;
                    } catch (e) {}
                }
            }

            conversationHistory.push({ role: 'assistant', content: fullContent });
            
        } catch (err) {
            document.querySelector(`#${msgId} .msg-content`).innerHTML = `<span style="color:var(--error)">Error: ${err.message}</span>`;
        }

        isStreaming = false;
        document.getElementById('sendBtn').disabled = false;
        currentMentions = [];
        area.scrollTop = area.scrollHeight;
    }

    function formatAIResponse(text) {
        // Format code blocks with copy/apply buttons
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
            const id = 'code-' + Math.random().toString(36).slice(2);
            return `
                <div class="code-block">
                    <div class="code-block-header">
                        <span>${lang || 'code'}</span>
                        <div class="code-actions">
                            <span class="code-action" onclick="copyCode('${id}')">üìã Copy</span>
                            <span class="code-action primary" onclick="applyCode('${id}')">‚ú® Apply</span>
                        </div>
                    </div>
                    <pre id="${id}"><code>${escapeHtml(code.trim())}</code></pre>
                </div>
            `;
        });
        
        // Inline code
        text = text.replace(/`([^`]+)`/g, '<code style="background:#333;padding:2px 6px;border-radius:3px;">$1</code>');
        
        // Bold
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Line breaks
        text = text.replace(/\n/g, '<br>');
        
        return text;
    }

    function copyCode(id) {
        const code = document.getElementById(id)?.textContent;
        if (code) {
            navigator.clipboard.writeText(code);
            toast('Code copied!', 'success');
        }
    }

    function applyCode(id) {
        const code = document.getElementById(id)?.textContent;
        if (code && editor && activeFile) {
            const selection = editor.getSelection();
            editor.executeEdits('ai-apply', [{
                range: selection,
                text: code
            }]);
            toast('Code applied!', 'success');
        } else {
            toast('Open a file first', 'error');
        }
    }

    function clearChat() {
        document.getElementById('chatArea').innerHTML = `
            <div class="msg ai">
                <div class="msg-header"><i class="codicon codicon-hubot"></i> Cursor AI</div>
                Chat cleared. How can I help?
            </div>
        `;
        conversationHistory = [];
    }

    function toggleAI() {
        const ai = document.getElementById('aiSide');
        const btn = document.getElementById('aiToggleBtn');
        const resizer = document.getElementById('rAI');
        const isVisible = ai.style.display !== 'none';
        
        ai.style.display = isVisible ? 'none' : 'flex';
        resizer.style.display = isVisible ? 'none' : 'block';
        btn.classList.toggle('active', !isVisible);
        
        if (editor) editor.layout();
    }

    // ==================== MODALS ====================
    function openPalette() {
        const modal = document.getElementById('paletteModal');
        modal.classList.add('open');
        
        const input = document.getElementById('paletteInput');
        input.value = '';
        input.focus();
        
        renderPaletteItems('');
        
        input.oninput = () => renderPaletteItems(input.value);
        modal.onclick = e => { if (e.target === modal) closeModal(); };
    }

    function renderPaletteItems(filter) {
        const commands = [
            { icon: 'new-file', label: 'New File', action: () => showNewFileModal('file') },
            { icon: 'new-folder', label: 'New Folder', action: () => showNewFileModal('folder') },
            { icon: 'save', label: 'Save File', shortcut: 'Ctrl+S', action: saveFile },
            { icon: 'search', label: 'Search in Files', shortcut: 'Ctrl+Shift+F', action: () => activateView('search') },
            { icon: 'terminal', label: 'Toggle Terminal', shortcut: 'Ctrl+`', action: togglePanel },
            { icon: 'settings-gear', label: 'Open Settings', shortcut: 'Ctrl+,', action: openSettings },
            { icon: 'hubot', label: 'Focus AI Chat', shortcut: 'Ctrl+L', action: () => document.getElementById('aiInput').focus() },
            { icon: 'open-preview', label: 'Toggle Preview', action: togglePreview },
            { icon: 'cloud-download', label: 'Import/Export Project', action: showImportExport },
            { icon: 'color-mode', label: 'Toggle Theme', action: () => setTheme(document.body.classList.contains('theme-light') ? 'dark' : 'light') },
            { icon: 'edit', label: 'Edit with AI (Ctrl+K)', shortcut: 'Ctrl+K', action: openInlineEdit },
            { icon: 'go-to-file', label: 'Go to Line', shortcut: 'Ctrl+G', action: openGotoLine },
            { icon: 'symbol-class', label: 'Go to Symbol', shortcut: 'Ctrl+Shift+O', action: openSymbolSearch },
            { icon: 'screen-full', label: 'Toggle Zen Mode', action: toggleZenMode },
            { icon: 'list-tree', label: 'Show Outline', action: () => activateView('outline') },
            { icon: 'history', label: 'Show File History', action: () => activateView('history') },
            { icon: 'close-all', label: 'Close All Tabs', action: () => { openFiles = []; activeFile = null; renderTabs(); showEmptyEditor(); } },
            { icon: 'discard', label: 'Discard All Changes', action: () => { Object.values(VFS).forEach(f => f.modified = false); renderTabs(); updateGitPanel(); toast('Changes discarded', 'info'); } },
            // New commands
            { icon: 'folder-opened', label: 'Open Folder from Computer', action: openRealFolder },
            { icon: 'mic', label: 'Voice Input', action: toggleVoiceInput },
            { icon: 'file-media', label: 'Attach Image to AI', action: toggleImageDrop },
            { icon: 'beaker', label: 'API Tester', action: () => switchPanel('api') },
            { icon: 'debug-console', label: 'JavaScript Console', action: () => switchPanel('console') },
            { icon: 'markdown', label: 'Markdown Preview', action: openMarkdownPreview },
            { icon: 'code', label: 'Format Document', shortcut: 'Ctrl+Alt+F', action: formatDocument },
            { icon: 'diff', label: 'Show Git Diff', action: showGitDiff },
            { icon: 'debug-breakpoint', label: 'Toggle Breakpoint', action: () => { if(editor) toggleBreakpoint(editor.getPosition()?.lineNumber); } },
            { icon: 'add', label: 'New Terminal', action: addNewTerminal },
            { icon: 'desktop-download', label: 'Install as App (PWA)', action: installPWA },
            { icon: 'refresh', label: 'Reload Preview', action: updatePreview },
            { icon: 'find-replace', label: 'Find and Replace', shortcut: 'Ctrl+H', action: () => editor?.trigger('keyboard', 'editor.action.startFindReplaceAction') },
            { icon: 'comment', label: 'Toggle Comment', shortcut: 'Ctrl+/', action: () => editor?.trigger('keyboard', 'editor.action.commentLine') },
            { icon: 'indent', label: 'Indent Lines', shortcut: 'Ctrl+]', action: () => editor?.trigger('keyboard', 'editor.action.indentLines') },
            { icon: 'fold', label: 'Fold All', action: () => editor?.trigger('keyboard', 'editor.foldAll') },
            { icon: 'unfold', label: 'Unfold All', action: () => editor?.trigger('keyboard', 'editor.unfoldAll') },
            { icon: 'word-wrap', label: 'Toggle Word Wrap', action: () => { settings.wordWrap = !settings.wordWrap; editor?.updateOptions({ wordWrap: settings.wordWrap ? 'on' : 'off' }); } },
            { icon: 'split-horizontal', label: 'Split Editor', action: () => toast('Split view: Not yet implemented', 'info') },
            { icon: 'json', label: 'Edit Settings JSON', action: () => openFile('.vscode/settings.json') },
        ];

        const filtered = filter 
            ? commands.filter(c => c.label.toLowerCase().includes(filter.toLowerCase()))
            : commands;

        document.getElementById('paletteList').innerHTML = filtered.map(c => `
            <div class="palette-item" onclick="closeModal(); (${c.action.toString()})()">
                <span class="palette-item-icon"><i class="codicon codicon-${c.icon}"></i></span>
                <span class="palette-item-label">${c.label}</span>
                ${c.shortcut ? `<span class="palette-item-shortcut">${c.shortcut}</span>` : ''}
            </div>
        `).join('');
    }

    function openQuickOpen() {
        const modal = document.getElementById('paletteModal');
        modal.classList.add('open');
        
        const input = document.getElementById('paletteInput');
        input.value = '';
        input.placeholder = 'Go to file...';
        input.focus();
        
        renderFileList('');
        
        input.oninput = () => renderFileList(input.value);
        modal.onclick = e => { if (e.target === modal) closeModal(); };
    }

    function renderFileList(filter) {
        const files = Object.keys(VFS).filter(f => 
            VFS[f].type !== 'folder' && f.toLowerCase().includes(filter.toLowerCase())
        );

        document.getElementById('paletteList').innerHTML = files.map(f => `
            <div class="palette-item" onclick="closeModal(); openFile('${f}')">
                <span class="palette-item-icon">${getFileIcon(f)}</span>
                <span class="palette-item-label">${f}</span>
            </div>
        `).join('');
    }

    function openSettings() {
        document.getElementById('settingsModal').classList.add('open');
        document.getElementById('apiKeyInput').value = apiKey;
    }

    function saveSettings() {
        apiKey = document.getElementById('apiKeyInput').value || DEFAULT_API_KEY;
        localStorage.setItem('apiKey', apiKey);
        closeModal();
        toast('Settings saved!', 'success');
    }

    function showImportExport() {
        document.getElementById('importExportModal').classList.add('open');
    }

    function exportProject() {
        const data = JSON.stringify(VFS, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cursor-project.json';
        a.click();
        URL.revokeObjectURL(url);
        toast('Project exported!', 'success');
        closeModal();
    }

    function importProject(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                VFS = JSON.parse(event.target.result);
                saveToLocalStorage();
                renderTree();
                toast('Project imported!', 'success');
                closeModal();
            } catch (err) {
                toast('Invalid JSON file', 'error');
            }
        };
        reader.readAsText(file);
    }

    function closeModal() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('open'));
        document.getElementById('paletteInput').placeholder = 'Type a command or search...';
    }

    // ==================== CTRL+K INLINE EDIT ====================
    let selectedText = '';
    let selectedRange = null;
    let pendingEdit = null;

    function openInlineEdit() {
        if (!editor || !activeFile) return toast('Open a file first', 'error');
        
        const selection = editor.getSelection();
        selectedText = editor.getModel().getValueInRange(selection);
        selectedRange = selection;
        
        if (!selectedText.trim()) {
            // If no selection, select current line
            const line = editor.getPosition().lineNumber;
            selectedText = editor.getModel().getLineContent(line);
            selectedRange = new monaco.Range(line, 1, line, selectedText.length + 1);
        }

        document.getElementById('inlineEditFile').textContent = activeFile;
        document.getElementById('inlineEditInput').value = '';
        document.getElementById('diffContent').innerHTML = `<div class="diff-side old">${escapeHtml(selectedText)}</div><div class="diff-side new">Type an instruction above...</div>`;
        document.getElementById('inlineEditActions').style.display = 'none';
        document.getElementById('inlineEditModal').classList.add('open');
        
        setTimeout(() => document.getElementById('inlineEditInput').focus(), 100);
    }

    document.getElementById('inlineEditInput')?.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            await generateInlineEdit();
        }
        if (e.key === 'Escape') closeModal();
    });

    async function generateInlineEdit() {
        const instruction = document.getElementById('inlineEditInput').value.trim();
        if (!instruction) return;

        document.getElementById('diffContent').innerHTML = `<div class="diff-side old">${escapeHtml(selectedText)}</div><div class="diff-side new" style="opacity:0.5">Generating...</div>`;

        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + apiKey,
                    'HTTP-Referer': location.href
                },
                body: JSON.stringify({
                    model: document.getElementById('modelSelect').value,
                    messages: [
                        { role: 'system', content: 'You are a code editor. Modify the given code according to the instruction. Return ONLY the modified code, no explanations, no markdown, no code blocks.' },
                        { role: 'user', content: `Original code:\n${selectedText}\n\nInstruction: ${instruction}` }
                    ]
                })
            });

            const data = await response.json();
            pendingEdit = data.choices?.[0]?.message?.content || selectedText;
            
            // Clean up the response
            pendingEdit = pendingEdit.replace(/^```\w*\n?/, '').replace(/\n?```$/, '').trim();

            document.getElementById('diffContent').innerHTML = `
                <div class="diff-side old">${escapeHtml(selectedText)}</div>
                <div class="diff-side new">${escapeHtml(pendingEdit)}</div>
            `;
            document.getElementById('inlineEditActions').style.display = 'flex';

        } catch (err) {
            toast('Error: ' + err.message, 'error');
        }
    }

    function acceptInlineEdit() {
        if (pendingEdit && editor && selectedRange) {
            editor.executeEdits('inline-edit', [{
                range: selectedRange,
                text: pendingEdit
            }]);
            toast('Changes applied!', 'success');
            addToHistory(activeFile, 'AI Edit');
        }
        closeModal();
        pendingEdit = null;
    }

    function rejectInlineEdit() {
        closeModal();
        pendingEdit = null;
        toast('Changes rejected', 'info');
    }

    // ==================== ZEN MODE ====================
    let isZenMode = false;

    function toggleZenMode() {
        isZenMode = !isZenMode;
        document.body.classList.toggle('zen-mode', isZenMode);
        if (editor) editor.layout();
        toast(isZenMode ? 'Zen Mode enabled (Esc to exit)' : 'Zen Mode disabled', 'info');
    }

    // ==================== GO TO LINE ====================
    function openGotoLine() {
        if (!editor) return;
        document.getElementById('gotoLineModal').classList.add('open');
        const input = document.getElementById('gotoLineInput');
        input.value = '';
        input.focus();
    }

    document.getElementById('gotoLineInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const line = parseInt(e.target.value);
            if (line && editor) {
                editor.revealLineInCenter(line);
                editor.setPosition({ lineNumber: line, column: 1 });
                editor.focus();
            }
            closeModal();
        }
        if (e.key === 'Escape') closeModal();
    });

    // ==================== SYMBOL SEARCH ====================
    function openSymbolSearch() {
        if (!editor || !activeFile) return;
        
        const content = VFS[activeFile]?.content || '';
        const symbols = extractSymbols(content);
        
        document.getElementById('symbolModal').classList.add('open');
        const input = document.getElementById('symbolInput');
        input.value = '';
        input.focus();
        
        renderSymbols(symbols, '');
        
        input.oninput = () => renderSymbols(symbols, input.value);
    }

    function extractSymbols(code) {
        const symbols = [];
        const lines = code.split('\n');
        
        lines.forEach((line, i) => {
            // Functions
            const funcMatch = line.match(/(?:function|const|let|var)\s+(\w+)\s*(?:=\s*(?:async\s*)?\(|=\s*function|\()/);
            if (funcMatch) symbols.push({ name: funcMatch[1], type: 'function', line: i + 1 });
            
            // Arrow functions
            const arrowMatch = line.match(/(?:const|let|var)\s+(\w+)\s*=\s*(?:async\s*)?\(/);
            if (arrowMatch && !funcMatch) symbols.push({ name: arrowMatch[1], type: 'function', line: i + 1 });
            
            // Classes
            const classMatch = line.match(/class\s+(\w+)/);
            if (classMatch) symbols.push({ name: classMatch[1], type: 'class', line: i + 1 });
        });
        
        return symbols;
    }

    function renderSymbols(symbols, filter) {
        const filtered = filter 
            ? symbols.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()))
            : symbols;
        
        document.getElementById('symbolList').innerHTML = filtered.map(s => `
            <div class="palette-item" onclick="gotoSymbol(${s.line})">
                <span class="outline-item"><span class="type ${s.type}">${s.type[0].toUpperCase()}</span></span>
                <span>${s.name}</span>
                <span style="opacity:0.5;margin-left:auto">:${s.line}</span>
            </div>
        `).join('') || '<div style="padding:15px;color:var(--text2)">No symbols found</div>';
    }

    function gotoSymbol(line) {
        if (editor) {
            editor.revealLineInCenter(line);
            editor.setPosition({ lineNumber: line, column: 1 });
            editor.focus();
        }
        closeModal();
    }

    // ==================== OUTLINE VIEW ====================
    function updateOutline() {
        if (!activeFile || !VFS[activeFile]) return;
        
        const content = VFS[activeFile].content;
        const symbols = extractSymbols(content);
        
        document.getElementById('outlineContent').innerHTML = symbols.length === 0
            ? '<div style="padding:15px;color:var(--text2)">No symbols found</div>'
            : symbols.map(s => `
                <div class="outline-item" onclick="gotoSymbol(${s.line})">
                    <span class="type ${s.type}">${s.type === 'function' ? '∆í' : 'C'}</span>
                    <span>${s.name}</span>
                    <span style="opacity:0.5;margin-left:auto;font-size:11px">:${s.line}</span>
                </div>
            `).join('');
    }

    // ==================== VERSION HISTORY ====================
    let fileHistory = JSON.parse(localStorage.getItem('fileHistory') || '{}');

    function addToHistory(filename, action = 'Edit') {
        if (!fileHistory[filename]) fileHistory[filename] = [];
        fileHistory[filename].unshift({
            time: new Date().toISOString(),
            action,
            content: VFS[filename]?.content || ''
        });
        // Keep last 20 versions
        fileHistory[filename] = fileHistory[filename].slice(0, 20);
        localStorage.setItem('fileHistory', JSON.stringify(fileHistory));
        updateHistoryView();
    }

    function updateHistoryView() {
        const container = document.getElementById('historyContent');
        if (!activeFile || !fileHistory[activeFile]) {
            container.innerHTML = '<div style="padding:15px;color:var(--text2)">No history for this file</div>';
            return;
        }
        
        container.innerHTML = fileHistory[activeFile].map((v, i) => `
            <div class="version-item" onclick="restoreVersion(${i})">
                <div class="version-time">${new Date(v.time).toLocaleString()}</div>
                <div class="version-changes">${v.action}</div>
            </div>
        `).join('');
    }

    function restoreVersion(index) {
        if (!activeFile || !fileHistory[activeFile]?.[index]) return;
        
        const version = fileHistory[activeFile][index];
        VFS[activeFile].content = version.content;
        
        if (editor) {
            editor.setValue(version.content);
        }
        
        saveToLocalStorage();
        toast('Version restored!', 'success');
    }

    // ==================== AI AGENTS ====================
    let currentAgent = 'default';
    const agentPrompts = {
        default: 'You are Cursor AI, an expert coding assistant. Be concise and helpful.',
        review: 'You are a senior code reviewer. Analyze the code for bugs, security issues, performance problems, and best practices. Be thorough but constructive.',
        debug: 'You are a debugging expert. Analyze the code to find bugs, explain what is wrong, and provide fixes. Focus on the root cause.',
        refactor: 'You are a refactoring expert. Improve the code quality, readability, and maintainability. Suggest better patterns and cleaner implementations.',
        docs: 'You are a documentation expert. Generate clear, comprehensive documentation including JSDoc comments, README content, and usage examples.'
    };

    function selectAgent(agent) {
        currentAgent = agent;
        document.querySelectorAll('.agent-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.agent-btn[data-agent="${agent}"]`)?.classList.add('active');
        
        const placeholders = {
            default: 'Ask about your code...',
            review: 'Paste code to review...',
            debug: 'Describe the bug or paste error...',
            refactor: 'What should I refactor?',
            docs: 'What should I document?'
        };
        document.getElementById('aiInput').placeholder = placeholders[agent] || placeholders.default;
    }

    // ==================== AUTO SAVE ====================
    let autoSaveInterval = null;

    function enableAutoSave() {
        if (autoSaveInterval) clearInterval(autoSaveInterval);
        autoSaveInterval = setInterval(() => {
            const modified = Object.entries(VFS).filter(([,f]) => f.modified);
            if (modified.length > 0) {
                modified.forEach(([name, file]) => {
                    file.modified = false;
                });
                saveToLocalStorage();
                renderTabs();
                // Don't show toast to avoid spam
            }
        }, 30000); // Auto save every 30 seconds
    }

    // ==================== SNIPPETS ====================
    const snippets = {
        'log': 'console.log($1);',
        'fn': 'function $1($2) {\n  $3\n}',
        'afn': 'const $1 = ($2) => {\n  $3\n};',
        'if': 'if ($1) {\n  $2\n}',
        'for': 'for (let i = 0; i < $1; i++) {\n  $2\n}',
        'fore': '$1.forEach(($2) => {\n  $3\n});',
        'map': '$1.map(($2) => $3)',
        'filter': '$1.filter(($2) => $3)',
        'try': 'try {\n  $1\n} catch (err) {\n  console.error(err);\n}',
        'async': 'async function $1($2) {\n  $3\n}',
        'await': 'const $1 = await $2;',
        'imp': "import $1 from '$2';",
        'exp': 'export const $1 = $2;',
        'expd': 'export default $1;',
        'class': 'class $1 {\n  constructor($2) {\n    $3\n  }\n}',
        'react': "import React from 'react';\n\nexport default function $1() {\n  return (\n    <div>\n      $2\n    </div>\n  );\n}"
    };

    // ==================== DRAG & DROP ====================
    document.addEventListener('DOMContentLoaded', () => {
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        document.body.addEventListener('drop', async (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            
            for (const file of files) {
                if (file.type.startsWith('text/') || file.name.match(/\.(js|jsx|ts|tsx|html|css|json|md|py|rb|go|rs|java|c|cpp|h|php|sql|sh|yml|yaml|xml|txt)$/i)) {
                    const content = await file.text();
                    VFS[file.name] = { type: 'file', content, modified: false };
                }
            }
            
            saveToLocalStorage();
            renderTree();
            toast(`Imported ${files.length} file(s)`, 'success');
        });
    });

    // ==================== FILE SYSTEM ACCESS API ====================
    let fileHandles = {};
    
    async function openRealFolder() {
        if (!('showDirectoryPicker' in window)) {
            toast('Your browser does not support File System Access API. Try Chrome or Edge.', 'error');
            return;
        }
        
        try {
            const dirHandle = await window.showDirectoryPicker();
            VFS = {};
            
            async function readDirectory(handle, path = '') {
                for await (const entry of handle.values()) {
                    const fullPath = path ? `${path}/${entry.name}` : entry.name;
                    
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        // Only read text files under 1MB
                        if (file.size < 1024 * 1024 && !file.name.match(/\.(png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|mp3|mp4|zip|tar|gz)$/i)) {
                            try {
                                const content = await file.text();
                                VFS[fullPath] = { type: 'file', content, modified: false };
                                fileHandles[fullPath] = entry;
                            } catch (e) {}
                        }
                    } else if (entry.kind === 'directory' && !entry.name.startsWith('.') && entry.name !== 'node_modules') {
                        VFS[fullPath] = { type: 'folder' };
                        await readDirectory(entry, fullPath);
                    }
                }
            }
            
            await readDirectory(dirHandle);
            document.getElementById('folderName').textContent = dirHandle.name.toUpperCase();
            saveToLocalStorage();
            renderTree();
            toast(`Opened folder: ${dirHandle.name}`, 'success');
            
        } catch (e) {
            if (e.name !== 'AbortError') toast('Error opening folder: ' + e.message, 'error');
        }
    }

    async function saveRealFile(filename) {
        const handle = fileHandles[filename];
        if (handle && VFS[filename]) {
            try {
                const writable = await handle.createWritable();
                await writable.write(VFS[filename].content);
                await writable.close();
                toast(`Saved to disk: ${filename}`, 'success');
            } catch (e) {
                toast('Error saving: ' + e.message, 'error');
            }
        }
    }

    // ==================== VOICE INPUT ====================
    let recognition = null;
    let isRecording = false;

    function toggleVoiceInput() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            toast('Speech recognition not supported in this browser', 'error');
            return;
        }

        const btn = document.getElementById('voiceBtn');
        
        if (isRecording) {
            recognition?.stop();
            isRecording = false;
            btn.classList.remove('recording');
            return;
        }

        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            isRecording = true;
            btn.classList.add('recording');
            toast('Listening... Speak now', 'info');
        };

        recognition.onresult = (e) => {
            const transcript = Array.from(e.results)
                .map(r => r[0].transcript)
                .join('');
            document.getElementById('aiInput').value = transcript;
        };

        recognition.onerror = (e) => {
            toast('Voice error: ' + e.error, 'error');
            isRecording = false;
            btn.classList.remove('recording');
        };

        recognition.onend = () => {
            isRecording = false;
            btn.classList.remove('recording');
        };

        recognition.start();
    }

    // ==================== IMAGE INPUT ====================
    let attachedImage = null;

    function toggleImageDrop() {
        const zone = document.getElementById('imageDropZone');
        zone.classList.toggle('hidden');
    }

    // Paste image
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData?.items;
        if (!items) return;
        
        for (const item of items) {
            if (item.type.startsWith('image/')) {
                e.preventDefault();
                const file = item.getAsFile();
                handleImageFile(file);
                break;
            }
        }
    });

    function handleImageFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            attachedImage = e.target.result;
            const preview = document.getElementById('imagePreview');
            preview.src = attachedImage;
            preview.classList.remove('hidden');
            document.getElementById('imageDropZone').classList.remove('hidden');
            toast('Image attached!', 'success');
        };
        reader.readAsDataURL(file);
    }

    // Drop zone
    const dropZone = document.getElementById('imageDropZone');
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file?.type.startsWith('image/')) handleImageFile(file);
        });
    }

    // ==================== CONSOLE PANEL ====================
    const consoleHistory = [];
    
    document.getElementById('consoleInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const input = e.target;
            const code = input.value.trim();
            if (!code) return;
            
            consoleHistory.push(code);
            input.value = '';
            
            const output = document.getElementById('consoleOutput');
            output.innerHTML += `<div class="console-line"><span style="color:var(--accent)">></span> ${escapeHtml(code)}</div>`;
            
            try {
                const result = eval(code);
                output.innerHTML += `<div class="console-line info">${escapeHtml(String(result))}</div>`;
            } catch (err) {
                output.innerHTML += `<div class="console-line error">${escapeHtml(err.message)}</div>`;
            }
            
            output.scrollTop = output.scrollHeight;
        }
    });

    // ==================== API TESTER ====================
    document.getElementById('apiMethod')?.addEventListener('change', (e) => {
        const body = document.getElementById('apiBody');
        body.style.display = ['POST', 'PUT', 'PATCH'].includes(e.target.value) ? 'block' : 'none';
    });

    async function sendApiRequest() {
        const method = document.getElementById('apiMethod').value;
        const url = document.getElementById('apiUrl').value;
        const body = document.getElementById('apiBody').value;
        const response = document.getElementById('apiResponse');
        
        if (!url) return toast('Enter a URL', 'error');
        
        response.textContent = 'Loading...';
        
        try {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body && ['POST', 'PUT', 'PATCH'].includes(method)) {
                options.body = body;
            }
            
            const res = await fetch(url, options);
            const data = await res.text();
            
            try {
                response.textContent = JSON.stringify(JSON.parse(data), null, 2);
            } catch {
                response.textContent = data;
            }
            
            response.innerHTML = `<div style="color:${res.ok ? 'var(--success)' : 'var(--error)'};margin-bottom:10px;">Status: ${res.status} ${res.statusText}</div>` + response.innerHTML;
            
        } catch (err) {
            response.innerHTML = `<div style="color:var(--error)">Error: ${err.message}</div>`;
        }
    }

    // ==================== MARKDOWN PREVIEW ====================
    function renderMarkdown(text) {
        // Use Marked if available, fallback to simple renderer
        if (typeof marked !== 'undefined' && marked.parse) {
            return marked.parse(text);
        }
        // Simple markdown renderer fallback
        return text
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
            .replace(/^\- (.*$)/gm, '<li>$1</li>')
            .replace(/\n/g, '<br>');
    }

    function openMarkdownPreview() {
        if (!activeFile || !activeFile.endsWith('.md')) {
            toast('Open a markdown file first', 'info');
            return;
        }
        
        const content = VFS[activeFile]?.content || '';
        const html = renderMarkdown(content);
        
        // Show in preview pane
        document.getElementById('previewFrame').srcdoc = `
            <!DOCTYPE html>
            <html>
            <head>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">
                <style>
                    body { background: #1e1e1e; padding: 20px; }
                    .markdown-body { max-width: 800px; margin: 0 auto; }
                </style>
            </head>
            <body class="markdown-body">${html}</body>
            </html>
        `;
        
        document.getElementById('previewContainer').classList.remove('hidden');
        toast('Markdown preview opened', 'success');
    }

    // ==================== COLOR PICKER ====================
    function initColorPicker() {
        if (editor) {
            editor.onDidChangeModelContent(() => {
                // Find color values and add preview
                const model = editor.getModel();
                if (!model) return;
                
                const decorations = [];
                const content = model.getValue();
                const colorRegex = /#([0-9A-Fa-f]{3,8})|rgb\([^)]+\)|hsl\([^)]+\)/g;
                
                // This is simplified - full implementation would need Monaco decorations
            });
        }
    }

    // ==================== FORMAT ON SAVE ====================
    let formatOnSave = localStorage.getItem('formatOnSave') === 'true';

    function toggleFormatOnSave() {
        formatOnSave = !formatOnSave;
        localStorage.setItem('formatOnSave', formatOnSave);
        toast(`Format on save: ${formatOnSave ? 'enabled' : 'disabled'}`, 'info');
    }

    function formatDocument() {
        if (editor) {
            editor.getAction('editor.action.formatDocument')?.run();
            toast('Document formatted', 'success');
        }
    }

    // Override save to format
    const originalSaveFile = saveFile;
    saveFile = function() {
        if (formatOnSave && editor) {
            editor.getAction('editor.action.formatDocument')?.run();
        }
        originalSaveFile();
        if (fileHandles[activeFile]) saveRealFile(activeFile);
    };

    // ==================== PWA INSTALL ====================
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showPWABanner();
    });

    function showPWABanner() {
        const banner = document.createElement('div');
        banner.className = 'pwa-banner';
        banner.innerHTML = `
            <i class="codicon codicon-desktop-download" style="font-size:24px;color:var(--accent)"></i>
            <div>
                <div style="font-weight:600">Install Cursor Clone</div>
                <div style="font-size:12px;color:var(--text2)">Add to your desktop for offline use</div>
            </div>
            <button class="btn" onclick="installPWA()">Install</button>
            <button class="btn secondary" onclick="this.parentElement.remove()">Later</button>
        `;
        document.body.appendChild(banner);
    }

    async function installPWA() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const result = await deferredPrompt.userChoice;
        if (result.outcome === 'accepted') {
            toast('App installed!', 'success');
        }
        deferredPrompt = null;
        document.querySelector('.pwa-banner')?.remove();
    }

    // ==================== SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
        // Register inline service worker using blob
        const swCode = `
            const CACHE = 'cursor-clone-v1';
            const ASSETS = ['/'];
            
            self.addEventListener('install', e => {
                e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS)));
            });
            
            self.addEventListener('fetch', e => {
                e.respondWith(
                    caches.match(e.request).then(r => r || fetch(e.request))
                );
            });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
    }

    // ==================== DIFF EDITOR ====================
    function openDiffEditor(file1, file2) {
        if (!VFS[file1] || !VFS[file2]) return;
        
        const content1 = VFS[file1].content;
        const content2 = VFS[file2].content;
        
        // Simple diff visualization
        const lines1 = content1.split('\n');
        const lines2 = content2.split('\n');
        
        let diffHtml = '<div class="diff-container"><div class="diff-pane">';
        
        const maxLines = Math.max(lines1.length, lines2.length);
        for (let i = 0; i < maxLines; i++) {
            const l1 = lines1[i] || '';
            const l2 = lines2[i] || '';
            const isDiff = l1 !== l2;
            
            diffHtml += `<div class="diff-line ${isDiff ? (l1 ? 'removed' : 'added') : ''}">
                <span class="diff-line-num">${i + 1}</span>
                <span class="diff-line-content">${escapeHtml(l1)}</span>
            </div>`;
        }
        
        diffHtml += '</div><div class="diff-pane">';
        
        for (let i = 0; i < maxLines; i++) {
            const l1 = lines1[i] || '';
            const l2 = lines2[i] || '';
            const isDiff = l1 !== l2;
            
            diffHtml += `<div class="diff-line ${isDiff ? (l2 ? 'added' : 'removed') : ''}">
                <span class="diff-line-num">${i + 1}</span>
                <span class="diff-line-content">${escapeHtml(l2)}</span>
            </div>`;
        }
        
        diffHtml += '</div></div>';
        
        // Show in a modal or panel
        toast('Diff view opened', 'info');
    }

    // ==================== AI AUTOCOMPLETE (Ghost Text) ====================
    let autocompleteTimeout = null;

    function initAIAutocomplete() {
        if (!editor) return;
        
        editor.onDidChangeModelContent(() => {
            clearTimeout(autocompleteTimeout);
            
            // Debounce autocomplete requests
            autocompleteTimeout = setTimeout(async () => {
                const position = editor.getPosition();
                const model = editor.getModel();
                if (!position || !model) return;
                
                const lineContent = model.getLineContent(position.lineNumber);
                const textBeforeCursor = lineContent.substring(0, position.column - 1);
                
                // Only suggest if we have some context
                if (textBeforeCursor.length < 3) return;
                
                // This would call AI for suggestions - simplified for demo
                // In production, use a dedicated autocomplete endpoint
            }, 500);
        });
    }

    // ==================== MULTI TERMINAL ====================
    let terminalInstances = [{ id: 0, name: 'bash', term: null }];
    let activeTerminalIdx = 0;

    function addNewTerminal() {
        const id = terminalInstances.length;
        terminalInstances.push({ id, name: `bash-${id}`, term: null });
        renderTerminalTabsUI();
        switchTerminalTo(id);
    }

    function switchTerminalTo(id) {
        activeTerminalIdx = id;
        renderTerminalTabsUI();
        
        // Show/hide terminal containers
        document.querySelectorAll('.term-instance').forEach(el => {
            el.style.display = el.dataset.id == id ? 'block' : 'none';
        });
    }

    function closeTerminal(id, event) {
        event?.stopPropagation();
        if (terminalInstances.length <= 1) return;
        
        terminalInstances = terminalInstances.filter(t => t.id !== id);
        document.querySelector(`.term-instance[data-id="${id}"]`)?.remove();
        
        if (activeTerminalIdx === id) {
            switchTerminalTo(terminalInstances[0]?.id || 0);
        }
        renderTerminalTabsUI();
    }

    function renderTerminalTabsUI() {
        const container = document.getElementById('terminalTabs');
        if (!container) return;
        
        container.innerHTML = terminalInstances.map(t => `
            <div class="terminal-tab ${t.id === activeTerminalIdx ? 'active' : ''}" 
                 data-id="${t.id}" onclick="switchTerminalTo(${t.id})">
                <i class="codicon codicon-terminal"></i>
                <span>${t.name}</span>
                ${terminalInstances.length > 1 ? `<i class="codicon codicon-close terminal-tab-close" onclick="closeTerminal(${t.id}, event)"></i>` : ''}
            </div>
        `).join('') + `
            <div class="terminal-tab" onclick="addNewTerminal()" style="padding:5px 10px;">
                <i class="codicon codicon-plus"></i>
            </div>
        `;
    }

    // ==================== WEBCONTAINERS (Real Node.js) ====================
    let webcontainer = null;
    let useWebContainer = false;

    async function initWebContainer() {
        if (!window.WebContainer) {
            console.log('WebContainers not available');
            return false;
        }
        
        try {
            webcontainer = await window.WebContainer.boot();
            useWebContainer = true;
            toast('WebContainer initialized! Real Node.js available.', 'success');
            
            // Mount the VFS
            const files = {};
            for (const [path, file] of Object.entries(VFS)) {
                if (file.type === 'file') {
                    files[path] = { file: { contents: file.content } };
                } else {
                    files[path] = { directory: {} };
                }
            }
            await webcontainer.mount(files);
            
            return true;
        } catch (e) {
            console.log('WebContainer init failed:', e);
            return false;
        }
    }

    async function runInWebContainer(command) {
        if (!webcontainer) return null;
        
        try {
            const [cmd, ...args] = command.split(' ');
            const process = await webcontainer.spawn(cmd, args);
            
            process.output.pipeTo(new WritableStream({
                write(data) {
                    if (term) term.write(data);
                }
            }));
            
            return await process.exit;
        } catch (e) {
            return null;
        }
    }

    // Try to init WebContainer on load
    setTimeout(() => {
        initWebContainer().catch(() => {});
    }, 2000);

    // ==================== ENHANCED SHORTCUTS ====================
    function initEnhancedShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ctrl+K - Inline Edit
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                if (e.shiftKey) {
                    // Ctrl+Shift+K - Delete line
                    if (editor) editor.trigger('keyboard', 'editor.action.deleteLines');
                } else {
                    openInlineEdit();
                }
            }
            
            // Ctrl+G - Go to line
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                openGotoLine();
            }
            
            // Ctrl+Shift+O - Go to symbol
            if (e.ctrlKey && e.shiftKey && e.key === 'O') {
                e.preventDefault();
                openSymbolSearch();
            }
            
            // Escape - Exit zen mode
            if (e.key === 'Escape' && isZenMode) {
                toggleZenMode();
            }
            
            // Ctrl+D - Add selection to next find match
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.addSelectionToNextFindMatch');
            }
            
            // Alt+Click is handled by Monaco for multi-cursor
            
            // Ctrl+Alt+F - Format document
            if (e.ctrlKey && e.altKey && e.key === 'f') {
                e.preventDefault();
                formatDocument();
            }
            
            // Ctrl+/ - Toggle comment
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.commentLine');
            }
            
            // Ctrl+] / Ctrl+[ - Indent/outdent
            if (e.ctrlKey && e.key === ']') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.indentLines');
            }
            if (e.ctrlKey && e.key === '[') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.outdentLines');
            }
            
            // F2 - Rename symbol
            if (e.key === 'F2') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.rename');
            }
            
            // F12 - Go to definition
            if (e.key === 'F12') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.revealDefinition');
            }
            
            // Ctrl+Space - Trigger suggest
            if (e.ctrlKey && e.key === ' ') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.triggerSuggest');
            }
            
            // Ctrl+Shift+F - Search in files
            if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                switchView('search');
                document.getElementById('searchInput')?.focus();
            }
            
            // Ctrl+H - Replace
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.startFindReplaceAction');
            }
            
            // Ctrl+Shift+L - Select all occurrences
            if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                e.preventDefault();
                if (editor) editor.trigger('keyboard', 'editor.action.selectHighlights');
            }
            
            // Ctrl+B - Toggle sidebar
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                document.getElementById('sidebar').classList.toggle('hidden');
            }
            
            // Ctrl+J - Toggle panel
            if (e.ctrlKey && e.key === 'j') {
                e.preventDefault();
                togglePanel();
            }
        });
    }

    // ==================== EMMET SUPPORT ====================
    function expandEmmet(abbreviation) {
        const expansions = {
            '!': '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Document</title>\n</head>\n<body>\n  \n</body>\n</html>',
            'html:5': '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Document</title>\n</head>\n<body>\n  \n</body>\n</html>',
            'div': '<div></div>',
            'ul>li*3': '<ul>\n  <li></li>\n  <li></li>\n  <li></li>\n</ul>',
            'ul>li*5': '<ul>\n  <li></li>\n  <li></li>\n  <li></li>\n  <li></li>\n  <li></li>\n</ul>',
            'table>tr*3>td*3': '<table>\n  <tr>\n    <td></td><td></td><td></td>\n  </tr>\n  <tr>\n    <td></td><td></td><td></td>\n  </tr>\n  <tr>\n    <td></td><td></td><td></td>\n  </tr>\n</table>',
            'form': '<form action="" method="post">\n  \n</form>',
            'input:text': '<input type="text" name="" id="">',
            'input:submit': '<input type="submit" value="">',
            'input:email': '<input type="email" name="" id="">',
            'input:password': '<input type="password" name="" id="">',
            'btn': '<button type="button"></button>',
            'a': '<a href=""></a>',
            'img': '<img src="" alt="">',
            'link:css': '<link rel="stylesheet" href="style.css">',
            'script:src': '<script src=""></script>',
            'lorem': 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
        };

        // Handle class and id syntax: div.class#id
        const match = abbreviation.match(/^(\w+)(\.[\w-]+)?(#[\w-]+)?$/);
        if (match) {
            const [, tag, cls, id] = match;
            let result = `<${tag || 'div'}`;
            if (id) result += ` id="${id.slice(1)}"`;
            if (cls) result += ` class="${cls.slice(1)}"`;
            result += `></${tag || 'div'}>`;
            return result;
        }

        return expansions[abbreviation] || abbreviation;
    }

    // Listen for Tab in editor to expand Emmet
    function initEmmet() {
        if (!editor) return;
        
        editor.addCommand(monaco.KeyCode.Tab, () => {
            const model = editor.getModel();
            const position = editor.getPosition();
            if (!model || !position) return;
            
            const line = model.getLineContent(position.lineNumber);
            const textBefore = line.substring(0, position.column - 1);
            
            // Find the abbreviation (last word)
            const abbrevMatch = textBefore.match(/[\w.#:*>]+$/);
            if (abbrevMatch && activeFile?.endsWith('.html')) {
                const abbrev = abbrevMatch[0];
                const expanded = expandEmmet(abbrev);
                
                if (expanded !== abbrev) {
                    const range = new monaco.Range(
                        position.lineNumber,
                        position.column - abbrev.length,
                        position.lineNumber,
                        position.column
                    );
                    editor.executeEdits('emmet', [{ range, text: expanded }]);
                    return;
                }
            }
            
            // Default tab behavior
            editor.trigger('keyboard', 'tab', null);
        });
    }

    // ==================== SETTINGS UI ====================
    let settings = {
        theme: localStorage.getItem('theme') || 'dark',
        fontSize: parseInt(localStorage.getItem('fontSize') || '14'),
        tabSize: parseInt(localStorage.getItem('tabSize') || '2'),
        wordWrap: localStorage.getItem('wordWrap') === 'true',
        formatOnSave: localStorage.getItem('formatOnSave') === 'true',
        autoSave: localStorage.getItem('autoSave') !== 'false',
        minimap: localStorage.getItem('minimap') !== 'false',
    };

    function openSettings() {
        const modal = document.getElementById('commandModal');
        modal.classList.add('active');
        modal.innerHTML = `
            <div class="command-palette" style="width:700px;max-height:80vh;">
                <div style="display:flex;border-bottom:1px solid var(--border);">
                    <div class="settings-nav">
                        <div class="settings-nav-item active" onclick="showSettingsSection('editor')">Editor</div>
                        <div class="settings-nav-item" onclick="showSettingsSection('appearance')">Appearance</div>
                        <div class="settings-nav-item" onclick="showSettingsSection('keybindings')">Keybindings</div>
                        <div class="settings-nav-item" onclick="showSettingsSection('ai')">AI</div>
                    </div>
                    <div class="settings-content" id="settingsContent">
                        ${getSettingsHtml('editor')}
                    </div>
                </div>
            </div>
        `;
    }

    function getSettingsHtml(section) {
        const sections = {
            editor: `
                <div class="setting-item">
                    <div class="setting-title">Font Size</div>
                    <div class="setting-desc">Controls the font size in pixels</div>
                    <div class="setting-control">
                        <input type="range" min="10" max="24" value="${settings.fontSize}" onchange="updateSetting('fontSize', this.value)">
                        <span>${settings.fontSize}px</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Tab Size</div>
                    <div class="setting-desc">The number of spaces a tab is equal to</div>
                    <div class="setting-control">
                        <select onchange="updateSetting('tabSize', this.value)" style="background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px;">
                            <option ${settings.tabSize === 2 ? 'selected' : ''}>2</option>
                            <option ${settings.tabSize === 4 ? 'selected' : ''}>4</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Word Wrap</div>
                    <div class="setting-desc">Controls how lines should wrap</div>
                    <div class="setting-control">
                        <div class="toggle-switch ${settings.wordWrap ? 'on' : ''}" onclick="toggleSetting('wordWrap', this)"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Format On Save</div>
                    <div class="setting-desc">Format a file on save</div>
                    <div class="setting-control">
                        <div class="toggle-switch ${settings.formatOnSave ? 'on' : ''}" onclick="toggleSetting('formatOnSave', this)"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Auto Save</div>
                    <div class="setting-desc">Automatically save files after changes</div>
                    <div class="setting-control">
                        <div class="toggle-switch ${settings.autoSave ? 'on' : ''}" onclick="toggleSetting('autoSave', this)"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Minimap</div>
                    <div class="setting-desc">Show minimap in editor</div>
                    <div class="setting-control">
                        <div class="toggle-switch ${settings.minimap ? 'on' : ''}" onclick="toggleSetting('minimap', this)"></div>
                    </div>
                </div>
            `,
            appearance: `
                <div class="setting-item">
                    <div class="setting-title">Theme</div>
                    <div class="setting-desc">Select the color theme</div>
                    <div class="setting-control">
                        <select onchange="updateSetting('theme', this.value)" style="background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px;">
                            <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>Dark (VS Dark+)</option>
                            <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>Light</option>
                        </select>
                    </div>
                </div>
            `,
            keybindings: `
                <div class="setting-item">
                    <div style="font-family:monospace;font-size:13px;">
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+S</div><div>Save File</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+P</div><div>Quick Open</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+Shift+P</div><div>Command Palette</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+K</div><div>Inline Edit with AI</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+L</div><div>Focus AI Chat</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+G</div><div>Go to Line</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+Shift+O</div><div>Go to Symbol</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+/</div><div>Toggle Comment</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+D</div><div>Add Selection to Next Match</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+B</div><div>Toggle Sidebar</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+J</div><div>Toggle Panel</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">Ctrl+\`</div><div>Toggle Terminal</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">F2</div><div>Rename Symbol</div>
                        </div>
                        <div style="display:flex;padding:8px 0;border-bottom:1px solid var(--border);">
                            <div style="width:200px;color:var(--accent)">F12</div><div>Go to Definition</div>
                        </div>
                        <div style="display:flex;padding:8px 0;">
                            <div style="width:200px;color:var(--accent)">Alt+Z</div><div>Toggle Word Wrap</div>
                        </div>
                    </div>
                </div>
            `,
            ai: `
                <div class="setting-item">
                    <div class="setting-title">API Key</div>
                    <div class="setting-desc">Your OpenRouter API key</div>
                    <div class="setting-control">
                        <input type="password" value="${API_KEY.slice(0, 10)}..." style="flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px;" readonly>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-title">Model</div>
                    <div class="setting-desc">Selected AI model: ${selectedModel || 'Default'}</div>
                </div>
            `
        };
        return sections[section] || '';
    }

    function showSettingsSection(section) {
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('settingsContent').innerHTML = getSettingsHtml(section);
    }

    function updateSetting(key, value) {
        settings[key] = key === 'fontSize' || key === 'tabSize' ? parseInt(value) : value;
        localStorage.setItem(key, value);
        
        if (editor) {
            if (key === 'fontSize') editor.updateOptions({ fontSize: settings.fontSize });
            if (key === 'tabSize') editor.updateOptions({ tabSize: settings.tabSize });
            if (key === 'wordWrap') editor.updateOptions({ wordWrap: settings.wordWrap ? 'on' : 'off' });
            if (key === 'minimap') editor.updateOptions({ minimap: { enabled: settings.minimap } });
        }
        
        toast(`${key} updated to ${value}`, 'success');
    }

    function toggleSetting(key, el) {
        settings[key] = !settings[key];
        localStorage.setItem(key, settings[key]);
        el.classList.toggle('on');
        
        if (editor) {
            if (key === 'wordWrap') editor.updateOptions({ wordWrap: settings[key] ? 'on' : 'off' });
            if (key === 'minimap') editor.updateOptions({ minimap: { enabled: settings[key] } });
        }
    }

    // ==================== REGEX SEARCH ====================
    function searchInFiles(query, isRegex = false, caseSensitive = false) {
        const results = [];
        
        for (const [path, file] of Object.entries(VFS)) {
            if (file.type !== 'file') continue;
            
            try {
                const regex = isRegex 
                    ? new RegExp(query, caseSensitive ? 'g' : 'gi')
                    : new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), caseSensitive ? 'g' : 'gi');
                
                const lines = file.content.split('\n');
                lines.forEach((line, index) => {
                    if (regex.test(line)) {
                        results.push({
                            file: path,
                            line: index + 1,
                            content: line.trim(),
                            matches: line.match(regex) || []
                        });
                    }
                    regex.lastIndex = 0; // Reset regex
                });
            } catch (e) {}
        }
        
        return results;
    }

    function replaceInFiles(query, replacement, isRegex = false) {
        let count = 0;
        
        for (const [path, file] of Object.entries(VFS)) {
            if (file.type !== 'file') continue;
            
            try {
                const regex = isRegex 
                    ? new RegExp(query, 'g')
                    : new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                
                const newContent = file.content.replace(regex, () => {
                    count++;
                    return replacement;
                });
                
                if (newContent !== file.content) {
                    VFS[path].content = newContent;
                    VFS[path].modified = true;
                }
            } catch (e) {}
        }
        
        saveToLocalStorage();
        renderTree();
        toast(`Replaced ${count} occurrences`, 'success');
        return count;
    }

    // ==================== BREAKPOINTS ====================
    let breakpoints = {};

    function toggleBreakpoint(line) {
        const file = activeFile;
        if (!file) return;
        
        if (!breakpoints[file]) breakpoints[file] = [];
        
        const index = breakpoints[file].indexOf(line);
        if (index > -1) {
            breakpoints[file].splice(index, 1);
        } else {
            breakpoints[file].push(line);
        }
        
        updateBreakpointDecorations();
    }

    function updateBreakpointDecorations() {
        if (!editor || !activeFile) return;
        
        const bp = breakpoints[activeFile] || [];
        const decorations = bp.map(line => ({
            range: new monaco.Range(line, 1, line, 1),
            options: {
                isWholeLine: true,
                glyphMarginClassName: 'breakpoint-decoration',
                glyphMarginHoverMessage: { value: 'Breakpoint' }
            }
        }));
        
        editor.deltaDecorations([], decorations);
    }

    // ==================== GIT DIFF INLINE ====================
    function showGitDiff() {
        const modified = Object.entries(VFS).filter(([_, f]) => f.modified);
        if (modified.length === 0) {
            toast('No modified files', 'info');
            return;
        }
        
        let html = '<div style="padding:15px;">';
        for (const [path, file] of modified) {
            html += `<div style="margin-bottom:20px;">
                <div style="font-weight:600;color:var(--accent);margin-bottom:10px;">${path}</div>
                <div style="background:#1e1e1e;padding:10px;border-radius:4px;font-family:monospace;font-size:12px;max-height:200px;overflow:auto;">
                    ${escapeHtml(file.content.slice(0, 500))}${file.content.length > 500 ? '...' : ''}
                </div>
            </div>`;
        }
        html += '</div>';
        
        document.getElementById('gitChanges').innerHTML = html;
        switchView('git');
    }

    // ==================== UTILITIES ====================
    function escapeHtml(text) {
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function saveToLocalStorage() {
        localStorage.setItem('vfs', JSON.stringify(VFS));
    }

    // Initialize enhanced features
    initEnhancedShortcuts();
    enableAutoSave();

    // Initialize tree on first load
    if (Object.keys(VFS).length > 0) {
        setTimeout(() => renderTree(), 100);
    }
    </script>
</body>
</html>